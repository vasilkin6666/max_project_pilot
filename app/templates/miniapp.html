<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_title }} ‚Äî MAX Project Pilot</title>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
            min-height: calc(100vh - 40px);
        }

        .project-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
        }

        .kanban {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding: 1rem 0;
            min-height: 400px;
        }

        .column {
            min-width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 1.5rem;
            border-top: 4px solid;
        }

        .column-todo { border-color: var(--warning); }
        .column-in_progress { border-color: var(--info); }
        .column-done { border-color: var(--success); }

        .column h5 {
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .task {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: grab;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.3;
        }

        .task:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .priority-high {
            border-color: var(--danger);
            color: var(--danger);
        }

        .priority-medium {
            border-color: var(--warning);
            color: var(--warning);
        }

        .priority-low {
            border-color: var(--success);
            color: var(--success);
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .task-assignees {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .task-due {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .task-due.overdue {
            color: var(--danger);
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--secondary);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="project-header">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-2">üöÄ {{ project_title }}</h1>
                    <p class="mb-0 opacity-75">MAX Project Pilot ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</p>
                </div>
                <div class="col-auto">
                    <button class="refresh-btn" onclick="loadTasks()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4" id="stats">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-warning" id="todo-count">0</div>
                    <div>‚è≥ –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-info" id="progress-count">0</div>
                    <div>üîß –í —Ä–∞–±–æ—Ç–µ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-success" id="done-count">0</div>
                    <div>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-primary" id="total-count">0</div>
                    <div>üìã –í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
            </div>
        </div>

        <!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
        <div class="kanban" id="board">
            <div class="column column-todo">
                <h5>‚è≥ –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</h5>
                <div class="tasks" data-status="todo"></div>
            </div>
            <div class="column column-in_progress">
                <h5>üîß –í —Ä–∞–±–æ—Ç–µ</h5>
                <div class="tasks" data-status="in_progress"></div>
            </div>
            <div class="column column-done">
                <h5>‚úÖ –ì–æ—Ç–æ–≤–æ</h5>
                <div class="tasks" data-status="done"></div>
            </div>
        </div>

        <div class="loading" id="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...
        </div>
    </div>

    <script>
        const PROJECT_HASH = "{{ project_hash }}";
        const API_BASE = `/api/projects/${PROJECT_HASH}`;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MAX Web App
        WebApp.ready();
        WebApp.expand();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
        async function loadTasks() {
            try {
                document.getElementById('loading').style.display = 'block';

                const res = await fetch(`${API_BASE}/tasks`);
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

                const data = await res.json();
                renderTasks(data.tasks);
                updateStats(data.tasks);

                document.getElementById('loading').style.display = 'none';
                WebApp.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á';
                WebApp.HapticFeedback.notificationOccurred('error');
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–¥–∞—á
        function renderTasks(tasks) {
            // –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
            document.querySelectorAll('.tasks').forEach(col => col.innerHTML = '');

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
            tasks.forEach(task => {
                const column = document.querySelector(`[data-status="${task.status}"]`);
                if (!column) return;

                const taskEl = createTaskElement(task);
                column.appendChild(taskEl);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏
        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task priority-${task.priority}`;

            const dueDate = task.due_date ? new Date(task.due_date) : null;
            const isOverdue = dueDate && dueDate < new Date();

            div.innerHTML = `
                <div class="task-title">${escapeHTML(task.title)}</div>
                ${task.description ? `<div class="task-description small text-muted mb-2">${escapeHTML(task.description)}</div>` : ''}
                <div class="task-assignees">
                    üë• ${task.assignees.length > 0 ? task.assignees.map(a => escapeHTML(a.full_name)).join(', ') : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'}
                </div>
                ${dueDate ? `
                    <div class="task-due ${isOverdue ? 'overdue' : ''}">
                        üìÖ ${dueDate.toLocaleDateString('ru-RU')} ${isOverdue ? '‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : ''}
                    </div>
                ` : ''}
                <div class="task-priority small mt-2">
                    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: <strong>${getPriorityText(task.priority)}</strong>
                </div>
            `;

            return div;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(tasks) {
            const todoCount = tasks.filter(t => t.status === 'todo').length;
            const progressCount = tasks.filter(t => t.status === 'in_progress').length;
            const doneCount = tasks.filter(t => t.status === 'done').length;
            const totalCount = tasks.length;

            document.getElementById('todo-count').textContent = todoCount;
            document.getElementById('progress-count').textContent = progressCount;
            document.getElementById('done-count').textContent = doneCount;
            document.getElementById('total-count').textContent = totalCount;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getPriorityText(priority) {
            const priorities = {
                'high': '–í—ã—Å–æ–∫–∏–π',
                'medium': '–°—Ä–µ–¥–Ω–∏–π',
                'low': '–ù–∏–∑–∫–∏–π'
            };
            return priorities[priority] || priority;
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        loadTasks();
        setInterval(loadTasks, 30000);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (e) => {
            console.error('Global error:', e);
            WebApp.HapticFeedback.notificationOccurred('error');
        });
    </script>
</body>
</html>
