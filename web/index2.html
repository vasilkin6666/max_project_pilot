<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pilot - Управление проектами</title>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
</head>
<body>
    <div id="loading" style="padding: 20px; text-align: center;">
        <p>Загрузка приложения...</p>
    </div>

    <div id="app" style="display: none;">
        <!-- Header -->
        <div style="padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;">Project Pilot</h1>
            <div style="display: flex; gap: 10px;">
                <button id="notificationsBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Уведомления
                </button>
                <button id="settingsBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Настройки
                </button>
                <button id="createProjectBtn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать проект
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="projectsCount">0</div>
                        <div>Проектов</div>
                    </div>
                    <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="tasksCount">0</div>
                        <div>Задач</div>
                    </div>
                </div>

                <div>
                    <h2>Мои проекты</h2>
                    <div id="projectsList">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Project Details View -->
            <div id="projectView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="projectTitleHeader">Название проекта</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="editProjectBtn" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Редактировать
                        </button>
                        <button id="deleteProjectBtn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Удалить
                        </button>
                        <button onclick="App.showDashboard()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назад
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <p id="projectDescriptionText">Описание проекта</p>
                    <div style="display: flex; gap: 15px; font-size: 14px; color: #666;">
                        <span>Участников: <span id="projectMembersCount">0</span></span>
                        <span>Всего задач: <span id="projectTotalTasks">0</span></span>
                        <span>Выполнено: <span id="projectDoneTasks">0</span></span>
                        <span>В работе: <span id="projectInProgressTasks">0</span></span>
                    </div>
                </div>

                <!-- Project Members -->
                <div style="margin-bottom: 20px;">
                    <h3>Участники проекта</h3>
                    <div id="projectMembersList">
                        <!-- Members will be loaded here -->
                    </div>
                </div>

                <!-- Project Tasks -->
                <div>
                    <h3>Задачи проекта</h3>
                    <div id="projectTasksList">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Join Requests View -->
            <div id="joinRequestsView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Заявки на вступление</h2>
                    <button onclick="App.showDashboard()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Назад
                    </button>
                </div>
                <div id="joinRequestsList">
                    <!-- Join requests will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Create Project Modal -->
    <div id="createProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Создать проект</h3>
                <button onclick="App.hideModal('createProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="createProjectForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название проекта *</label>
                    <input type="text" id="projectTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('createProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleCreateProject()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Редактировать проект</h3>
                <button onclick="App.hideModal('editProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="editProjectForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название проекта *</label>
                    <input type="text" id="editProjectTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="editProjectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="editProjectIsPrivate"> Приватный проект
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="editProjectRequiresApproval"> Требуется одобрение для вступления
                    </label>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('editProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleUpdateProject()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Project Modal -->
    <div id="deleteProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Удалить проект</h3>
                <button onclick="App.hideModal('deleteProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <p>Вы уверены, что хотите удалить проект "<span id="deleteProjectName"></span>"? Это действие нельзя отменить.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('deleteProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleDeleteProject()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Удалить
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Уведомления</h3>
                <div>
                    <button onclick="App.markAllNotificationsRead()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                        Прочитать все
                    </button>
                    <button onclick="App.hideModal('notificationsModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
                </div>
            </div>
            <div id="notificationsList">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Настройки пользователя</h3>
                <button onclick="App.hideModal('settingsModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="settingsForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Имя</label>
                    <input type="text" id="userFullName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Имя пользователя</label>
                    <input type="text" id="userUsername" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Тема</label>
                    <select id="userTheme" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="light">Светлая</option>
                        <option value="dark">Темная</option>
                        <option value="auto">Авто</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="userNotificationsEnabled"> Уведомления включены
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="userCompactView"> Компактный вид
                    </label>
                </div>
            </form>
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="App.resetUserPreferences()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сбросить настройки
                </button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="App.hideModal('settingsModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Отмена
                    </button>
                    <button onclick="App.handleSaveSettings()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация
        const CONFIG = {
            API_BASE_URL: 'https://powerfully-exotic-chamois.cloudpub.ru/api'
        };

        // Глобальные переменные
        let currentProject = null;
        let currentUser = null;

        // Менеджер аутентификации
        class AuthManager {
            static async initialize() {
                try {
                    console.log('Initializing authentication...');

                    // Проверяем MAX окружение
                    if (typeof WebApp !== 'undefined' && WebApp.initDataUnsafe?.user) {
                        return await this.authenticateWithMax();
                    } else {
                        // Для разработки - тестовый пользователь
                        return await this.authenticateWithTestUser();
                    }
                } catch (error) {
                    console.error('Authentication failed:', error);
                    throw error;
                }
            }

            static async authenticateWithMax() {
                const userData = WebApp.initDataUnsafe.user;
                const maxId = userData.id.toString();
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Пользователь MAX';

                console.log('MAX authentication with:', { maxId, fullName });

                const tokenData = await ApiService.getAuthToken(maxId, fullName, userData.username || '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('MAX authentication successful');
                    return tokenData.user;
                }

                throw new Error('MAX authentication failed');
            }

            static async authenticateWithTestUser() {
                const testId = 'dev_user_' + Math.random().toString(36).substr(2, 9);
                const fullName = 'Тестовый пользователь';

                console.log('Test authentication with:', { testId, fullName });

                const tokenData = await ApiService.getAuthToken(testId, fullName, '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('Test authentication successful');
                    return tokenData.user;
                }

                throw new Error('Test authentication failed');
            }

            static getToken() {
                return localStorage.getItem('access_token');
            }

            static isAuthenticated() {
                return !!this.getToken();
            }
        }

        // API сервис
        class ApiService {
            static async request(endpoint, options = {}) {
                const token = AuthManager.getToken();
                const url = `${CONFIG.API_BASE_URL}${endpoint}`;

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                console.log(`API Request: ${options.method || 'GET'} ${url}`);

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log(`API Response:`, data);
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            static async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            static async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            static async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            static async patch(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
            }

            static async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }

            // Auth endpoints
            static async getAuthToken(maxId, fullName, username) {
                return this.post('/auth/token', {
                    max_id: maxId,
                    full_name: fullName,
                    username: username
                });
            }

            // Project endpoints
            static async getProjects() {
                return this.get('/projects/');
            }

            static async createProject(projectData) {
                return this.post('/projects/', projectData);
            }

            static async getProject(projectHash) {
                return this.get(`/projects/${projectHash}`);
            }

            static async updateProject(projectHash, projectData) {
                return this.put(`/projects/${projectHash}`, projectData);
            }

            static async deleteProject(projectHash) {
                return this.delete(`/projects/${projectHash}`);
            }

            static async getProjectMembers(projectHash) {
                return this.get(`/projects/${projectHash}/members`);
            }

            static async getProjectJoinRequests(projectHash) {
                return this.get(`/projects/${projectHash}/join-requests`);
            }

            static async approveJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/approve`);
            }

            static async rejectJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/reject`);
            }

            // Task endpoints
            static async getTasks(projectHash) {
                return this.get(`/tasks/projects/${projectHash}/tasks`);
            }

            static async createTask(taskData) {
                return this.post('/tasks/', taskData);
            }

            // User endpoints
            static async getCurrentUser() {
                return this.get('/users/me');
            }

            static async updateCurrentUser(userData) {
                return this.put('/users/me', userData);
            }

            static async getUserPreferences() {
                return this.get('/users/me/preferences');
            }

            static async updateUserPreferences(preferences) {
                return this.put('/users/me/preferences', preferences);
            }

            static async resetUserPreferences() {
                return this.put('/users/me/preferences/reset');
            }

            // Dashboard endpoints
            static async getDashboard() {
                return this.get('/dashboard/');
            }

            // Notifications endpoints
            static async getNotifications() {
                return this.get('/notifications/');
            }

            static async markAllNotificationsRead() {
                return this.put('/notifications/mark_all_read');
            }
        }

        // Основное приложение
        class App {
            static async init() {
                try {
                    console.log('Initializing app...');

                    // Инициализируем аутентификацию
                    currentUser = await AuthManager.initialize();

                    // Показываем основное приложение
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';

                    // Загружаем данные
                    await this.loadData();

                    // Настраиваем обработчики событий
                    this.setupEventListeners();

                    console.log('App initialized successfully');

                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showError('Ошибка инициализации приложения: ' + error.message);
                }
            }

            static async loadData() {
                try {
                    console.log('Loading data...');

                    // Загружаем дашборд с проектами
                    const dashboardData = await ApiService.getDashboard();
                    const projects = dashboardData.projects || [];

                    this.renderProjects(projects);
                    this.updateStats(projects);

                    console.log('Data loaded successfully');

                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            static renderProjects(projects) {
                const container = document.getElementById('projectsList');

                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; border: 1px solid #ccc; border-radius: 4px;">
                            <p>Проектов пока нет</p>
                            <button onclick="App.showModal('createProjectModal')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Создать первый проект
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = projects.map(project => {
                    const projectData = project.project || project;
                    const stats = projectData.stats || {};

                    return `
                        <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; cursor: pointer;"
                             onclick="App.openProject('${projectData.hash}')">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">${this.escapeHtml(projectData.title)}</div>
                            <div style="color: #666; margin-bottom: 10px;">${this.escapeHtml(projectData.description || 'Без описания')}</div>
                            <div style="display: flex; gap: 15px; font-size: 14px; color: #888;">
                                <span>Участников: ${stats.members_count || 0}</span>
                                <span>Задач: ${stats.tasks_count || 0}</span>
                                <span>Выполнено: ${stats.tasks_done || 0}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            static updateStats(projects) {
                document.getElementById('projectsCount').textContent = projects.length;

                const totalTasks = projects.reduce((sum, project) => {
                    const stats = (project.project || project).stats || {};
                    return sum + (stats.tasks_count || 0);
                }, 0);

                document.getElementById('tasksCount').textContent = totalTasks;
            }

            static setupEventListeners() {
                // Создание проекта
                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    this.showModal('createProjectModal');
                });

                // Уведомления
                document.getElementById('notificationsBtn').addEventListener('click', () => {
                    this.showNotifications();
                });

                // Настройки
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showSettings();
                });

                // Редактирование проекта
                document.getElementById('editProjectBtn').addEventListener('click', () => {
                    this.showEditProjectModal();
                });

                // Удаление проекта
                document.getElementById('deleteProjectBtn').addEventListener('click', () => {
                    this.showDeleteProjectModal();
                });
            }

            static showView(viewId) {
                // Скрываем все вью
                document.getElementById('dashboardView').style.display = 'none';
                document.getElementById('projectView').style.display = 'none';
                document.getElementById('joinRequestsView').style.display = 'none';

                // Показываем нужную вью
                document.getElementById(viewId).style.display = 'block';
            }

            static showDashboard() {
                this.showView('dashboardView');
                this.loadData();
            }

            static async openProject(projectHash) {
                try {
                    console.log('Opening project:', projectHash);

                    const projectData = await ApiService.getProject(projectHash);
                    currentProject = projectData.project || projectData;

                    // Обновляем заголовок и описание
                    document.getElementById('projectTitleHeader').textContent = currentProject.title;
                    document.getElementById('projectDescriptionText').textContent = currentProject.description || 'Без описания';

                    // Обновляем статистику
                    document.getElementById('projectMembersCount').textContent = currentProject.members_count || 0;
                    document.getElementById('projectTotalTasks').textContent = currentProject.total_tasks || 0;
                    document.getElementById('projectDoneTasks').textContent = currentProject.done_tasks || 0;
                    document.getElementById('projectInProgressTasks').textContent = currentProject.in_progress_tasks || 0;

                    // Загружаем участников
                    await this.loadProjectMembers(projectHash);

                    // Загружаем задачи
                    await this.loadProjectTasks(projectHash);

                    // Показываем вью проекта
                    this.showView('projectView');

                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showError('Ошибка открытия проекта: ' + error.message);
                }
            }

            static async loadProjectMembers(projectHash) {
                try {
                    const members = await ApiService.getProjectMembers(projectHash);
                    const container = document.getElementById('projectMembersList');

                    if (!members || members.length === 0) {
                        container.innerHTML = '<p>Участников нет</p>';
                        return;
                    }

                    container.innerHTML = members.map(member => `
                        <div style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                            <div style="font-weight: bold;">${this.escapeHtml(member.full_name)}</div>
                            <div style="color: #666; font-size: 14px;">
                                Роль: ${member.role} |
                                Username: ${member.username || 'не указан'}
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading project members:', error);
                    document.getElementById('projectMembersList').innerHTML = '<p>Ошибка загрузки участников</p>';
                }
            }

            static async loadProjectTasks(projectHash) {
                try {
                    const tasks = await ApiService.getTasks(projectHash);
                    const container = document.getElementById('projectTasksList');

                    if (!tasks || tasks.length === 0) {
                        container.innerHTML = '<p>Задач нет</p>';
                        return;
                    }

                    container.innerHTML = tasks.map(task => `
                        <div style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                            <div style="font-weight: bold;">${this.escapeHtml(task.title)}</div>
                            <div style="color: #666; font-size: 14px;">
                                Статус: ${task.status} |
                                Приоритет: ${task.priority}
                                ${task.due_date ? `| Срок: ${new Date(task.due_date).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading project tasks:', error);
                    document.getElementById('projectTasksList').innerHTML = '<p>Ошибка загрузки задач</p>';
                }
            }

            static showEditProjectModal() {
                if (!currentProject) return;

                document.getElementById('editProjectTitle').value = currentProject.title;
                document.getElementById('editProjectDescription').value = currentProject.description || '';
                document.getElementById('editProjectIsPrivate').checked = currentProject.is_private;
                document.getElementById('editProjectRequiresApproval').checked = currentProject.requires_approval;

                this.showModal('editProjectModal');
            }

            static async handleUpdateProject() {
                if (!currentProject) return;

                const title = document.getElementById('editProjectTitle').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const isPrivate = document.getElementById('editProjectIsPrivate').checked;
                const requiresApproval = document.getElementById('editProjectRequiresApproval').checked;

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    await ApiService.updateProject(currentProject.hash, {
                        title,
                        description,
                        is_private: isPrivate,
                        requires_approval: requiresApproval
                    });

                    this.hideModal('editProjectModal');
                    await this.openProject(currentProject.hash); // Перезагружаем проект
                    this.showSuccess('Проект обновлен успешно!');

                } catch (error) {
                    console.error('Error updating project:', error);
                    this.showError('Ошибка обновления проекта: ' + error.message);
                }
            }

            static showDeleteProjectModal() {
                if (!currentProject) return;

                document.getElementById('deleteProjectName').textContent = currentProject.title;
                this.showModal('deleteProjectModal');
            }

            static async handleDeleteProject() {
                if (!currentProject) return;

                try {
                    await ApiService.deleteProject(currentProject.hash);

                    this.hideModal('deleteProjectModal');
                    this.showDashboard();
                    this.showSuccess('Проект удален успешно!');

                } catch (error) {
                    console.error('Error deleting project:', error);
                    this.showError('Ошибка удаления проекта: ' + error.message);
                }
            }

            static async showNotifications() {
                try {
                    const notifications = await ApiService.getNotifications();
                    const container = document.getElementById('notificationsList');

                    if (!notifications || notifications.length === 0) {
                        container.innerHTML = '<p>Уведомлений нет</p>';
                    } else {
                        container.innerHTML = notifications.map(notification => `
                            <div style="padding: 10px; border-bottom: 1px solid #ccc;">
                                <div style="font-weight: bold;">${this.escapeHtml(notification.title || 'Уведомление')}</div>
                                <div style="color: #666;">${this.escapeHtml(notification.message || '')}</div>
                                <div style="font-size: 12px; color: #999;">${new Date(notification.created_at).toLocaleString()}</div>
                            </div>
                        `).join('');
                    }

                    this.showModal('notificationsModal');

                } catch (error) {
                    console.error('Error loading notifications:', error);
                    this.showError('Ошибка загрузки уведомлений: ' + error.message);
                }
            }

            static async markAllNotificationsRead() {
                try {
                    await ApiService.markAllNotificationsRead();
                    this.hideModal('notificationsModal');
                    this.showSuccess('Все уведомления отмечены как прочитанные!');
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                    this.showError('Ошибка отметки уведомлений: ' + error.message);
                }
            }

            static async showSettings() {
                try {
                    // Загружаем данные пользователя
                    const userData = await ApiService.getCurrentUser();
                    const preferences = await ApiService.getUserPreferences();

                    // Заполняем форму
                    document.getElementById('userFullName').value = userData.full_name || '';
                    document.getElementById('userUsername').value = userData.username || '';
                    document.getElementById('userTheme').value = preferences.theme || 'light';
                    document.getElementById('userNotificationsEnabled').checked = preferences.notifications_enabled;
                    document.getElementById('userCompactView').checked = preferences.compact_view;

                    this.showModal('settingsModal');

                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.showError('Ошибка загрузки настроек: ' + error.message);
                }
            }

            static async handleSaveSettings() {
                try {
                    // Обновляем данные пользователя
                    await ApiService.updateCurrentUser({
                        full_name: document.getElementById('userFullName').value.trim(),
                        username: document.getElementById('userUsername').value.trim()
                    });

                    // Обновляем настройки
                    await ApiService.updateUserPreferences({
                        theme: document.getElementById('userTheme').value,
                        notifications_enabled: document.getElementById('userNotificationsEnabled').checked,
                        compact_view: document.getElementById('userCompactView').checked
                    });

                    this.hideModal('settingsModal');
                    this.showSuccess('Настройки сохранены успешно!');

                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Ошибка сохранения настроек: ' + error.message);
                }
            }

            static async resetUserPreferences() {
                try {
                    await ApiService.resetUserPreferences();
                    this.hideModal('settingsModal');
                    this.showSuccess('Настройки сброшены к значениям по умолчанию!');
                } catch (error) {
                    console.error('Error resetting preferences:', error);
                    this.showError('Ошибка сброса настроек: ' + error.message);
                }
            }

            static showModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            static hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            static async handleCreateProject() {
                const title = document.getElementById('projectTitle').value.trim();
                const description = document.getElementById('projectDescription').value.trim();

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    console.log('Creating project:', { title, description });

                    await ApiService.createProject({
                        title,
                        description,
                        is_private: true,
                        requires_approval: false
                    });

                    // Закрываем модальное окно
                    this.hideModal('createProjectModal');

                    // Очищаем форму
                    document.getElementById('createProjectForm').reset();

                    // Перезагружаем данные
                    await this.loadData();

                    this.showSuccess('Проект создан успешно!');

                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showError('Ошибка создания проекта: ' + error.message);
                }
            }

            static showError(message) {
                alert('Ошибка: ' + message);
            }

            static showSuccess(message) {
                alert('Успех: ' + message);
            }

            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
