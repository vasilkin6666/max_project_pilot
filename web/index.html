<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pilot - Управление проектами</title>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
</head>
<body>
    <div id="loading" style="padding: 20px; text-align: center;">
        <p>Загрузка приложения...</p>
    </div>

    <div id="app" style="display: none;">
        <!-- Header -->
        <div style="padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;">Project Pilot</h1>
            <div style="display: flex; gap: 10px;">
                <button id="searchProjectsBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Поиск проектов
                </button>
                <button id="notificationsBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Уведомления
                </button>
                <button id="myTasksBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Мои задачи
                </button>
                <button id="settingsBtn" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Настройки
                </button>
                <button id="createProjectBtn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать проект
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="projectsCount">0</div>
                        <div>Проектов</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="tasksCount">0</div>
                        <div>Задач</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="recentTasksCount">0</div>
                        <div>Недавние задачи</div>
                    </div>
                </div>

                <!-- Recent Tasks Section -->
                <div style="margin-bottom: 30px;">
                    <h2>Недавние задачи</h2>
                    <div id="recentTasksList">
                        <!-- Recent tasks will be loaded here -->
                    </div>
                </div>

                <div>
                    <h2>Мои проекты</h2>
                    <div id="projectsList">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Project Details View -->
            <div id="projectView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 id="projectTitleHeader">Название проекта</h2>
                        <div id="projectHashInfo" style="display: none; font-size: 14px; color: #666; margin-top: 5px;">
                            Хэш проекта: <span id="projectHashValue"></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="manageMembersBtn" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Участники
                        </button>
                        <button id="joinRequestsBtn" style="padding: 8px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                            Заявки
                        </button>
                        <button id="editProjectBtn" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Редактировать
                        </button>
                        <button id="deleteProjectBtn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Удалить
                        </button>
                        <button onclick="App.showDashboard()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назад
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <p id="projectDescriptionText">Описание проекта</p>
                    <div style="display: flex; gap: 15px; font-size: 14px; color: #666; flex-wrap: wrap;">
                        <span>Участников: <span id="projectMembersCount">0</span></span>
                        <span>Всего задач: <span id="projectTotalTasks">0</span></span>
                        <span>Выполнено: <span id="projectDoneTasks">0</span></span>
                        <span>В работе: <span id="projectInProgressTasks">0</span></span>
                    </div>
                </div>

                <!-- Project Tasks Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Задачи проекта</h3>
                        <button id="createTaskBtn" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Создать задачу
                        </button>
                    </div>
                    <div id="projectTasksList">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- Project Members -->
                <div style="margin-bottom: 20px;">
                    <h3>Участники проекта</h3>
                    <div id="projectMembersList">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Task Details View -->
            <div id="taskView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="taskTitleHeader">Название задачи</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="createSubtaskBtn" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Создать подзадачу
                        </button>
                        <button id="editTaskBtn" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Редактировать
                        </button>
                        <button id="deleteTaskBtn" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Удалить
                        </button>
                        <button onclick="App.backToProject()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назад к проекту
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Основная информация -->
                    <div>
                        <div style="margin-bottom: 20px;">
                            <h3>Описание</h3>
                            <p id="taskDescriptionText">Описание задачи</p>
                        </div>

                        <!-- Подзадачи -->
                        <div id="subtasksSection" style="margin-bottom: 20px;">
                            <h3>Подзадачи</h3>
                            <div id="subtasksList">
                                <!-- Subtasks will be loaded here -->
                            </div>
                        </div>

                        <!-- Комментарии -->
                        <div>
                            <h3>Комментарии</h3>
                            <div id="taskCommentsList" style="margin-bottom: 15px;">
                                <!-- Comments will be loaded here -->
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newCommentText" placeholder="Введите комментарий..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <button onclick="App.addComment()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Добавить
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Боковая панель -->
                    <div>
                        <div style="margin-bottom: 20px;">
                            <h3>Информация</h3>
                            <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Статус:</strong>
                                    <select id="taskStatusSelect" onchange="App.updateTaskStatus()" style="margin-left: 10px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="todo">К выполнению</option>
                                        <option value="in_progress">В работе</option>
                                        <option value="done">Выполнено</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Приоритет:</strong> <span id="taskPriorityText">Средний</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Создана:</strong> <span id="taskCreatedAtText">-</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Срок:</strong> <span id="taskDueDateText">Не установлен</span>
                                </div>
                                <div>
                                    <strong>Назначена:</strong> <span id="taskAssignedToText">Не назначена</span>
                                </div>
                            </div>
                        </div>

                        <!-- Зависимости -->
                        <div id="dependenciesSection">
                            <h3>Зависимости</h3>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <select id="addDependencySelect" style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="">Выберите задачу для добавления зависимости</option>
                                    </select>
                                    <button onclick="App.addTaskDependency()" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Добавить
                                    </button>
                                </div>
                            </div>
                            <div id="taskDependenciesList" style="margin-bottom: 15px;">
                                <!-- Dependencies will be loaded here -->
                            </div>
                            <div id="taskDependentsList" style="margin-bottom: 15px;">
                                <!-- Dependents will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Tasks View -->
            <div id="myTasksView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Мои задачи</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="tasksFilterStatus" onchange="App.loadMyTasks()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Все статусы</option>
                            <option value="todo">К выполнению</option>
                            <option value="in_progress">В работе</option>
                            <option value="done">Выполнено</option>
                        </select>
                        <select id="tasksFilterProject" onchange="App.loadMyTasks()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Все проекты</option>
                        </select>
                        <button onclick="App.showDashboard()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назад
                        </button>
                    </div>
                </div>
                <div id="myTasksList">
                    <!-- User tasks will be loaded here -->
                </div>
            </div>

            <!-- Search Projects View -->
            <div id="searchProjectsView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Поиск проектов</h2>
                    <button onclick="App.showDashboard()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Назад
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchProjectsInput" placeholder="Поиск по названию проекта..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <button onclick="App.searchProjects()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        Искать
                    </button>
                </div>
                <div id="searchResultsList">
                    <!-- Search results will be loaded here -->
                </div>
            </div>

            <!-- Join Requests View -->
            <div id="joinRequestsView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Заявки на вступление</h2>
                    <button onclick="App.backToProject()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Назад к проекту
                    </button>
                </div>
                <div id="joinRequestsList">
                    <!-- Join requests will be loaded here -->
                </div>
            </div>

            <!-- Project Members Management View -->
            <div id="projectMembersView" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Управление участниками</h2>
                    <button onclick="App.backToProject()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Назад к проекту
                    </button>
                </div>
                <div id="projectMembersManagementList">
                    <!-- Members management will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Create Project Modal -->
    <div id="createProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Создать проект</h3>
                <button onclick="App.hideModal('createProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="createProjectForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название проекта *</label>
                    <input type="text" id="projectTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="projectIsPrivate" checked> Приватный проект
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="projectRequiresApproval"> Требуется одобрение для вступления
                    </label>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('createProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleCreateProject()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать
                </button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Создать задачу</h3>
                <button onclick="App.hideModal('createTaskModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>

            <!-- УБЕДИТЕСЬ, ЧТО ЭТА ФОРМА СУЩЕСТВУЕТ -->
            <form id="createTaskForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название задачи *</label>
                    <input type="text" id="taskTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="taskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Приоритет</label>
                    <select id="taskPriority" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="low">Низкий</option>
                        <option value="medium" selected>Средний</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Срок выполнения</label>
                    <input type="date" id="taskDueDate" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Родительская задача</label>
                    <select id="taskParentId" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Основная задача (без родителя)</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Исполнитель</label>
                    <select id="taskAssignedTo" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Не назначена</option>
                    </select>
                </div>
            </form>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('createTaskModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleCreateTask()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать
                </button>
            </div>
        </div>
    </div>

    <!-- Create Subtask Modal -->
    <div id="createSubtaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Создать подзадачу</h3>
                <button onclick="App.hideModal('createSubtaskModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="createSubtaskForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название подзадачи *</label>
                    <input type="text" id="subtaskTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <!-- Описание скрыто для подзадачи -->
                <div style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="subtaskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <!-- Приоритет скрыт, наследуется от родителя -->
                <div style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px;">Приоритет</label>
                    <select id="subtaskPriority" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="low">Низкий</option>
                        <option value="medium" selected>Средний</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                    </select>
                </div>
                <!-- Срок выполнения скрыт, наследуется от родителя -->
                <div style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px;">Срок выполнения</label>
                    <input type="date" id="subtaskDueDate" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Исполнитель</label>
                    <select id="subtaskAssignedTo" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Не назначена</option>
                    </select>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('createSubtaskModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleCreateSubtask()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Уведомления</h3>
                <button onclick="App.hideModal('notificationsModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <div id="notificationsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <!-- Notifications will be loaded here -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="App.markAllNotificationsRead()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отметить все как прочитанные
                </button>
                <button onclick="App.hideModal('notificationsModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Настройки</h3>
                <button onclick="App.hideModal('settingsModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="settingsForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Полное имя</label>
                    <input type="text" id="userFullName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Имя пользователя</label>
                    <input type="text" id="userUsername" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Тема</label>
                    <select id="userTheme" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="light">Светлая</option>
                        <option value="dark">Темная</option>
                        <option value="auto">Авто</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="userNotificationsEnabled"> Уведомления включены
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="userCompactView"> Компактный вид
                    </label>
                </div>
            </form>
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button onclick="App.resetUserPreferences()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сбросить настройки
                </button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="App.hideModal('settingsModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Отмена
                    </button>
                    <button onclick="App.handleSaveSettings()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Редактировать проект</h3>
                <button onclick="App.hideModal('editProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="editProjectForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название проекта *</label>
                    <input type="text" id="editProjectTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="editProjectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="editProjectIsPrivate"> Приватный проект
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="editProjectRequiresApproval"> Требуется одобрение для вступления
                    </label>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('editProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleUpdateProject()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Project Modal -->
    <div id="deleteProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Удалить проект</h3>
                <button onclick="App.hideModal('deleteProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <p>Вы уверены, что хотите удалить проект "<span id="deleteProjectName"></span>"? Это действие нельзя отменить.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('deleteProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleDeleteProject()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Удалить
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Редактировать задачу</h3>
                <button onclick="App.hideModal('editTaskModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="editTaskForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название задачи *</label>
                    <input type="text" id="editTaskTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="editTaskDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Приоритет</label>
                    <select id="editTaskPriority" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="low">Низкий</option>
                        <option value="medium">Средний</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Срок выполнения</label>
                    <input type="date" id="editTaskDueDate" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('editTaskModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleUpdateTask()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Task Modal -->
    <div id="deleteTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Удалить задачу</h3>
                <button onclick="App.hideModal('deleteTaskModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <p>Вы уверены, что хотите удалить задачу "<span id="deleteTaskName"></span>"? Это действие нельзя отменить.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('deleteTaskModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleDeleteTask()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Удалить
                </button>
            </div>
        </div>
    </div>

    <!-- Update Member Role Modal -->
    <div id="updateMemberRoleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Изменить роль участника</h3>
                <button onclick="App.hideModal('updateMemberRoleModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <p>Участник: <strong id="memberName"></strong></p>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">Роль</label>
                <select id="memberRoleSelect" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="owner">Владелец</option>
                    <option value="admin">Администратор</option>
                    <option value="member">Участник</option>
                    <option value="guest">Гость</option>
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('updateMemberRoleModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleUpdateMemberRole()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Remove Member Modal -->
    <div id="removeMemberModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Удалить участника</h3>
                <button onclick="App.hideModal('removeMemberModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <p>Вы уверены, что хотите удалить участника "<strong id="removeMemberName"></strong>" из проекта? Это действие нельзя отменить.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('removeMemberModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleRemoveMember()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Удалить
                </button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация
        const CONFIG = {
            API_BASE_URL: 'https://powerfully-exotic-chamois.cloudpub.ru/api'
        };

        // Глобальные переменные
        let currentProject = null;
        let currentTask = null;
        let currentUser = null;
        let currentMemberToUpdate = null;
        let currentMemberToRemove = null;
        let userSettings = {};
        // Константы ролей проекта
        const ProjectRole = {
            OWNER: 'owner',
            ADMIN: 'admin',
            MEMBER: 'member',
            GUEST: 'guest'
        };
        // Менеджер аутентификации
        class AuthManager {
            static async initialize() {
                try {
                    console.log('Initializing authentication...');

                    // Проверяем MAX окружение
                    if (typeof WebApp !== 'undefined' && WebApp.initDataUnsafe?.user) {
                        return await this.authenticateWithMax();
                    } else {
                        // Для разработки - тестовый пользователь
                        return await this.authenticateWithTestUser();
                    }
                } catch (error) {
                    console.error('Authentication failed:', error);
                    throw error;
                }
            }

            static async authenticateWithMax() {
                const userData = WebApp.initDataUnsafe.user;
                const maxId = userData.id.toString();
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Пользователь MAX';

                console.log('MAX authentication with:', { maxId, fullName });

                const tokenData = await ApiService.getAuthToken(maxId, fullName, userData.username || '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('MAX authentication successful');
                    return tokenData.user;
                }

                throw new Error('MAX authentication failed');
            }

            static async authenticateWithTestUser() {
                const testId = 'dev_user_' + Math.random().toString(36).substr(2, 9);
                const fullName = 'Тестовый пользователь';

                console.log('Test authentication with:', { testId, fullName });

                const tokenData = await ApiService.getAuthToken(testId, fullName, '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('Test authentication successful');
                    return tokenData.user;
                }

                throw new Error('Test authentication failed');
            }

            static getToken() {
                return localStorage.getItem('access_token');
            }

            static isAuthenticated() {
                return !!this.getToken();
            }
        }

        // API сервис
        class ApiService {
            static async request(endpoint, options = {}) {
                const token = AuthManager.getToken();
                const url = `${CONFIG.API_BASE_URL}${endpoint}`;

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                console.log(`API Request: ${options.method || 'GET'} ${url}`);

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log(`API Response:`, data);
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            static async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            static async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            static async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            static async patch(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
            }

            static async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }

            // Auth endpoints
            static async getAuthToken(maxId, fullName, username) {
                return this.post('/auth/token', {
                    max_id: maxId,
                    full_name: fullName,
                    username: username
                });
            }

            // Project endpoints
            static async getProjects() {
                return this.get('/projects/');
            }

            static async createProject(projectData) {
                return this.post('/projects/', projectData);
            }

            static async getProject(projectHash) {
                return this.get(`/projects/${projectHash}`);
            }

            static async updateProject(projectHash, projectData) {
                return this.put(`/projects/${projectHash}`, projectData);
            }

            static async deleteProject(projectHash) {
                return this.delete(`/projects/${projectHash}`);
            }

            static async getProjectMembers(projectHash) {
                return this.get(`/projects/${projectHash}/members`);
            }

            static async updateMemberRole(projectHash, userId, role) {
                return this.put(`/projects/${projectHash}/members/${userId}`, { role });
            }

            static async removeProjectMember(projectHash, userId) {
                return this.delete(`/projects/${projectHash}/members/${userId}`);
            }

            static async approveJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/approve`);
            }

            static async rejectJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/reject`);
            }

            static async getProjectJoinRequests(projectHash) {
                return this.get(`/projects/${projectHash}/join-requests`);
            }

            static async joinProject(projectHash) {
                try {
                    const response = await ApiService.joinProject(projectHash);

                    if (response.status === 'joined') {
                        this.showSuccess('Вы успешно присоединились к проекту!');
                        // Открываем проект
                        await this.openProject(projectHash);
                    } else if (response.status === 'pending_approval') {
                        this.showSuccess('Заявка на вступление отправлена! Ожидайте одобрения.');
                        // Закрываем поиск и возвращаемся к дашборду
                        this.showDashboard();
                    }
                } catch (error) {
                    console.error('Error joining project:', error);
                    if (error.message.includes('400') && error.message.includes('already a member')) {
                        this.showError('Вы уже являетесь участником этого проекта');
                        await this.openProject(projectHash);
                    } else if (error.message.includes('400') && error.message.includes('already pending')) {
                        this.showError('Заявка на вступление уже отправлена');
                    } else {
                        this.showError('Ошибка вступления в проект: ' + error.message);
                    }
                }
            }

            static async regenerateInvite(projectHash) {
                return this.post(`/projects/${projectHash}/regenerate-invite`);
            }

            static async getProjectSummary(projectHash) {
                return this.get(`/projects/${projectHash}/summary`);
            }

            // Поиск публичных проектов
            static async searchPublicProjects(query = '') {
                const params = query ? `?query=${encodeURIComponent(query)}` : '';
                return this.get(`/projects/search/public${params}`);
            }

            // Получить проект по точному хэшу
            static async getProjectByHashExact(projectHash) {
                return this.get(`/projects/by-hash/${projectHash}`);
            }

            // Task endpoints
            static async getTasks(projectHash) {
                return this.get(`/tasks/projects/${projectHash}/tasks`);
            }

            static async getUserTasks(filters = {}) {
                const params = new URLSearchParams();
                if (filters.status) params.append('status', filters.status);
                if (filters.project_hash) params.append('project_hash', filters.project_hash);

                const query = params.toString();
                return this.get(`/tasks/${query ? `?${query}` : ''}`);
            }

            static async createTask(taskData) {
                // Преобразуем assigned_to_ids в assigned_to_id если нужно
                if (taskData.assigned_to_ids && taskData.assigned_to_ids.length > 0) {
                    taskData.assigned_to_id = taskData.assigned_to_ids[0];
                    delete taskData.assigned_to_ids;
                }
                return this.post('/tasks/', taskData);
            }

            static async getTask(taskId) {
                return this.get(`/tasks/${taskId}`);
            }

            static async updateTask(taskId, taskData) {
                // Преобразуем assigned_to_ids в assigned_to_id если нужно
                if (taskData.assigned_to_ids && taskData.assigned_to_ids.length > 0) {
                    taskData.assigned_to_id = taskData.assigned_to_ids[0];
                    delete taskData.assigned_to_ids;
                } else if (taskData.assigned_to_ids && taskData.assigned_to_ids.length === 0) {
                    taskData.assigned_to_id = null;
                    delete taskData.assigned_to_ids;
                }
                return this.put(`/tasks/${taskId}`, taskData);
            }

            static async deleteTask(taskId) {
                return this.delete(`/tasks/${taskId}`);
            }

            static async updateTaskStatus(taskId, status) {
                return this.put(`/tasks/${taskId}/status?status=${status}`);
            }

            // Управление зависимостями задач
            static async getTaskDependencies(taskId) {
                return this.get(`/tasks/${taskId}/dependencies`);
            }

            static async addTaskDependency(taskId, dependsOnId) {
                return this.post(`/tasks/${taskId}/dependencies?depends_on_id=${dependsOnId}`);
            }

            static async removeTaskDependency(taskId, dependsOnId) {
                return this.delete(`/tasks/${taskId}/dependencies?depends_on_id=${dependsOnId}`);
            }

            static async getTaskComments(taskId) {
                return this.get(`/tasks/${taskId}/comments`);
            }

            static async createTaskComment(taskId, content) {
                return this.post(`/tasks/${taskId}/comments?content=${encodeURIComponent(content)}`);
            }

            // User endpoints
            static async getCurrentUser() {
                return this.get('/users/me');
            }

            // ИСПРАВЛЕНО: Правильное обновление пользователя
            static async updateCurrentUser(userData) {
                const params = new URLSearchParams();
                if (userData.full_name) params.append('full_name', userData.full_name);
                if (userData.username) params.append('username', userData.username);

                return this.request(`/users/me?${params}`, { method: 'PUT' });
            }

            static async getUserPreferences() {
                return this.get('/users/me/preferences');
            }

            static async updateUserPreferences(preferences) {
                return this.put('/users/me/preferences', preferences);
            }

            static async patchUserPreferences(preferences) {
                return this.patch('/users/me/preferences', preferences);
            }

            static async resetUserPreferences() {
                return this.put('/users/me/preferences/reset');
            }

            static async getUser(userId) {
                return this.get(`/users/${userId}`);
            }

            // Получение проектов пользователя
            static async getUserProjects(userId) {
                return this.get(`/users/${userId}/projects`);
            }

            static async deleteJoinRequest(projectHash, requestId) {
                return this.delete(`/projects/${projectHash}/join-requests/${requestId}`);
            }

            // Notifications endpoints
            static async getNotifications() {
                return this.get('/notifications/');
            }

            static async markAllNotificationsRead() {
                return this.put('/notifications/mark_all_read');
            }

            // Dashboard endpoints
            static async getDashboard() {
                return this.get('/dashboard/');
            }

            // Health endpoints
            static async healthCheck() {
                return this.get('/health');
            }

            static async apiHealthCheck() {
                return this.get('/api/health');
            }
        }

        // Основное приложение
        class App {
            static async init() {
                try {
                    console.log('Initializing app...');

                    // Инициализируем аутентификацию
                    currentUser = await AuthManager.initialize();

                    // Показываем основное приложение
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';

                    // Загружаем данные
                    await this.loadData();

                    // Настраиваем обработчики событий
                    this.setupEventListeners();

                    console.log('App initialized successfully');

                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showError('Ошибка инициализации приложения: ' + error.message);
                }
            }

            static async loadData() {
                try {
                    console.log('Loading data...');

                    // Загружаем дашборд с проектами
                    const dashboardData = await ApiService.getDashboard();
                    const projects = dashboardData.projects || [];
                    const settings = dashboardData.settings || {};
                    const recentTasks = dashboardData.recent_tasks || [];

                    // Сохраняем настройки
                    userSettings = settings;
                    this.applyUserSettings(settings);

                    this.renderProjects(projects);
                    this.updateStats(projects, recentTasks);
                    this.renderRecentTasks(recentTasks);

                    console.log('Data loaded successfully');

                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            // Применение настроек пользователя
            static applyUserSettings(settings) {
                if (settings.theme) {
                    document.documentElement.setAttribute('data-theme', settings.theme);
                }
            }

            static renderProjects(projects) {
                const container = document.getElementById('projectsList');
                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; border: 1px solid #ccc; border-radius: 4px;">
                            <p>Проектов пока нет</p>
                            <button onclick="App.showModal('createProjectModal')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Создать первый проект
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = projects.map(project => {
                    // ИСПРАВЛЕНО: Правильное получение данных проекта и статистики
                    const projectData = project.project || project;

                    // Получаем статистику из разных возможных источников
                    const stats = project.stats || projectData.stats || {};

                    // ИСПРАВЛЕНО: Правильные названия полей статистики
                    const membersCount = stats.members_count || stats.membersCount || 0;
                    const tasksCount = stats.tasks_count || stats.tasksCount || 0;
                    const doneTasks = stats.tasks_done || stats.done_tasks || stats.doneTasks || 0;
                    const inProgressTasks = stats.tasks_in_progress || stats.in_progress_tasks || stats.inProgressTasks || 0;
                    const todoTasks = stats.tasks_todo || stats.todo_tasks || stats.todoTasks || 0;

                    console.log('Project stats for', projectData.title, ':', stats); // Для отладки

                    return `
                        <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; cursor: pointer;"
                             onclick="App.openProject('${projectData.hash}')">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">${this.escapeHtml(projectData.title)}</div>
                            <div style="color: #666; margin-bottom: 10px;">${this.escapeHtml(projectData.description || 'Без описания')}</div>
                            <div style="display: flex; gap: 15px; font-size: 14px; color: #888; flex-wrap: wrap;">
                                <span>Участников: ${membersCount}</span>
                                <span>Задач: ${tasksCount}</span>
                                <span>Выполнено: ${doneTasks}</span>
                                <span>В работе: ${inProgressTasks}</span>
                                <span>К выполнению: ${todoTasks}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Отображение недавних задач
            static renderRecentTasks(recentTasks) {
                const container = document.getElementById('recentTasksList');

                if (!recentTasks || recentTasks.length === 0) {
                    container.innerHTML = '<p>Нет недавних задач</p>';
                    return;
                }

                container.innerHTML = recentTasks.map(task => `
                    <div style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; cursor: pointer;"
                         onclick="App.openTask(${task.id})">
                        <div style="font-weight: bold;">${this.escapeHtml(task.title)}</div>
                        <div style="color: #666; font-size: 14px;">
                            Статус: ${this.getStatusText(task.status)} |
                            Приоритет: ${this.getPriorityText(task.priority)}
                            ${task.due_date ? `| Срок: ${new Date(task.due_date).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                `).join('');
            }

            static updateStats(projects, recentTasks) {
                // ИСПРАВЛЕНО: Правильный подсчет статистики
                document.getElementById('projectsCount').textContent = projects.length;

                const totalTasks = projects.reduce((sum, project) => {
                    const projectData = project.project || project;
                    const stats = project.stats || projectData.stats || {};
                    return sum + (stats.tasks_count || stats.tasksCount || 0);
                }, 0);

                document.getElementById('tasksCount').textContent = totalTasks;
                document.getElementById('recentTasksCount').textContent = recentTasks ? recentTasks.length : 0;
            }

            static setupEventListeners() {
              // Обработка нажатия Enter в поле поиска проектов
              document.getElementById('searchProjectsInput').addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      this.searchProjects();
                  }
              });
                // Создание проекта
                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    this.showModal('createProjectModal');
                });

                // Поиск проектов
                document.getElementById('searchProjectsBtn').addEventListener('click', () => {
                    this.showSearchProjects();
                });

                // Уведомления
                document.getElementById('notificationsBtn').addEventListener('click', () => {
                    this.showNotifications();
                });

                // Мои задачи
                document.getElementById('myTasksBtn').addEventListener('click', () => {
                    this.showMyTasks();
                });

                // Настройки
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showSettings();
                });

                // Редактирование проекта
                document.getElementById('editProjectBtn').addEventListener('click', () => {
                    this.showEditProjectModal();
                });

                // Удаление проекта
                document.getElementById('deleteProjectBtn').addEventListener('click', () => {
                    this.showDeleteProjectModal();
                });

                // Управление участниками
                document.getElementById('manageMembersBtn').addEventListener('click', () => {
                    this.showProjectMembersManagement();
                });

                // Заявки на вступление
                document.getElementById('joinRequestsBtn').addEventListener('click', () => {
                    this.showJoinRequests();
                });

                // Создание задачи
                document.getElementById('createTaskBtn').addEventListener('click', () => {
                    this.showCreateTaskModal();
                });

                // Создание подзадачи
                document.getElementById('createSubtaskBtn').addEventListener('click', () => {
                    this.showCreateSubtaskModal();
                });

                // Редактирование задачи
                document.getElementById('editTaskBtn').addEventListener('click', () => {
                    this.showEditTaskModal();
                });

                // Удаление задачи
                document.getElementById('deleteTaskBtn').addEventListener('click', () => {
                    this.showDeleteTaskModal();
                });

                const debugBtn = document.createElement('button');
                debugBtn.textContent = 'Debug';
                debugBtn.style.padding = '8px 12px';
                debugBtn.style.background = '#6c757d';
                debugBtn.style.color = 'white';
                debugBtn.style.border = 'none';
                debugBtn.style.borderRadius = '4px';
                debugBtn.style.cursor = 'pointer';
                debugBtn.style.marginLeft = '10px';
                debugBtn.onclick = () => this.debugProjectData();
                document.querySelector('div[style*="display: flex; gap: 10px;"]').appendChild(debugBtn);
            }

            static showView(viewId) {
                // Скрываем все вью
                document.getElementById('dashboardView').style.display = 'none';
                document.getElementById('projectView').style.display = 'none';
                document.getElementById('taskView').style.display = 'none';
                document.getElementById('myTasksView').style.display = 'none';
                document.getElementById('searchProjectsView').style.display = 'none';
                document.getElementById('joinRequestsView').style.display = 'none';
                document.getElementById('projectMembersView').style.display = 'none';

                // Показываем нужную вью
                document.getElementById(viewId).style.display = 'block';
            }

            static showDashboard() {
                this.showView('dashboardView');
                this.loadData();
            }

            static async showSearchProjects() {
                this.showView('searchProjectsView');
                // Сбрасываем поле поиска
                document.getElementById('searchProjectsInput').value = '';
                // Показываем недавние публичные проекты при открытии
                await this.loadRecentPublicProjects();
            }

            static async loadRecentPublicProjects() {
                try {
                    const response = await ApiService.searchPublicProjects();
                    const projects = response.projects || [];
                    this.renderSearchResults(projects, 'Недавние публичные проекты');
                } catch (error) {
                    console.error('Error loading recent public projects:', error);
                    document.getElementById('searchResultsList').innerHTML = '<p>Ошибка загрузки проектов</p>';
                }
            }

            static async showMyTasks() {
                try {
                    await this.loadMyTasks();
                    this.showView('myTasksView');
                } catch (error) {
                    console.error('Error showing my tasks:', error);
                    this.showError('Ошибка загрузки задач: ' + error.message);
                }
            }

            static async loadMyTasks() {
                try {
                    const statusFilter = document.getElementById('tasksFilterStatus').value;
                    const projectFilter = document.getElementById('tasksFilterProject').value;

                    const filters = {};
                    if (statusFilter) filters.status = statusFilter;
                    if (projectFilter) filters.project_hash = projectFilter;

                    const response = await ApiService.getUserTasks(filters);
                    const tasks = response.tasks || [];
                    const container = document.getElementById('myTasksList');

                    if (!tasks || tasks.length === 0) {
                        container.innerHTML = '<p>Задач нет</p>';
                        return;
                    }

                    // Фильтруем только основные задачи (без родительских задач)
                    const mainTasks = tasks.filter(task => task.parent_task_id === null);

                    container.innerHTML = mainTasks.map(task => `
                        <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; cursor: pointer;"
                             onclick="App.openTask(${task.id})">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${this.escapeHtml(task.title)}</div>
                            <div style="color: #666; margin-bottom: 8px;">${this.escapeHtml(task.description || 'Без описания')}</div>
                            <div style="display: flex; gap: 15px; font-size: 14px; color: #888; flex-wrap: wrap;">
                                <span>Статус: ${this.getStatusText(task.status)}</span>
                                <span>Приоритет: ${this.getPriorityText(task.priority)}</span>
                                ${task.due_date ? `<span>Срок: ${new Date(task.due_date).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading user tasks:', error);
                    document.getElementById('myTasksList').innerHTML = '<p>Ошибка загрузки задач</p>';
                }
            }

            static async openProject(projectHash) {
                try {
                    console.log('Opening project:', projectHash);
                    const projectData = await ApiService.getProject(projectHash);

                    // ИСПРАВЛЕНО: Правильное получение данных проекта
                    currentProject = projectData.project || projectData;
                    currentProject.members = projectData.members || [];

                    // Получаем сводку проекта для статистики
                    const projectSummary = await ApiService.getProjectSummary(projectHash);

                    console.log('Project data:', currentProject);
                    console.log('Project summary:', projectSummary);

                    // Обновляем заголовок и описание
                    document.getElementById('projectTitleHeader').textContent = currentProject.title;
                    document.getElementById('projectDescriptionText').textContent = currentProject.description || 'Без описания';

                    // ИСПРАВЛЕНО: Используем данные из сводки проекта для статистики
                    document.getElementById('projectMembersCount').textContent = projectSummary.members_count || 0;
                    document.getElementById('projectTotalTasks').textContent = projectSummary.tasks_count || 0;
                    document.getElementById('projectDoneTasks').textContent = projectSummary.tasks_done || 0;
                    document.getElementById('projectInProgressTasks').textContent = projectSummary.tasks_in_progress || 0;

                    // Показываем хэш проекта для владельцев и админов
                    const hashInfo = document.getElementById('projectHashInfo');
                    const hashValue = document.getElementById('projectHashValue');
                    const userRole = projectData.current_user_role || currentProject.current_user_role;

                    if (userRole === 'owner' || userRole === 'admin') {
                        hashInfo.style.display = 'block';
                        hashValue.textContent = currentProject.hash;
                    } else {
                        hashInfo.style.display = 'none';
                    }

                    // Настройка прав доступа
                    const canEditProject = userRole === 'owner';
                    const canManageRequests = userRole === 'owner' || userRole === 'admin';
                    const canManageMembers = userRole === 'owner' || userRole === 'admin';

                    // Показываем/скрываем кнопки управления
                    document.getElementById('editProjectBtn').style.display = canEditProject ? 'block' : 'none';
                    document.getElementById('deleteProjectBtn').style.display = canEditProject ? 'block' : 'none';
                    document.getElementById('joinRequestsBtn').style.display = canManageRequests ? 'block' : 'none';
                    document.getElementById('manageMembersBtn').style.display = canManageMembers ? 'block' : 'none';

                    // Загружаем участников и задачи
                    await this.loadProjectMembers(projectHash);
                    await this.loadProjectTasks(projectHash);

                    this.showView('projectView');
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showError('Ошибка открытия проекта: ' + error.message);
                }
            }

            static async loadProjectMembers(projectHash) {
                try {
                    const response = await ApiService.getProjectMembers(projectHash);
                    const members = response.members || [];
                    const container = document.getElementById('projectMembersList');

                    if (!members || members.length === 0) {
                        container.innerHTML = '<p>Участников нет</p>';
                        return;
                    }

                    container.innerHTML = members.map(member => {
                        // ИСПРАВЛЕНО: Правильное получение данных участника
                        const memberData = member.user || member;
                        const displayName = (memberData.full_name && memberData.full_name.trim() !== '')
                            ? memberData.full_name
                            : (member.full_name && member.full_name.trim() !== '')
                            ? member.full_name
                            : `Участник #${member.user_id || memberData.id}`;

                        return `
                            <div style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                                <div style="font-weight: bold;">${this.escapeHtml(displayName)}</div>
                                <div style="color: #666; font-size: 14px;">
                                    Роль: ${this.getRoleText(member.role)}
                                    ${(member.user_id || memberData.id) === currentUser.id ? ' (Вы)' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('Error loading project members:', error);
                    document.getElementById('projectMembersList').innerHTML = '<p>Ошибка загрузки участников</p>';
                }
            }

            static async loadProjectTasks(projectHash) {
                try {
                    const response = await ApiService.getTasks(projectHash);
                    const tasks = response.tasks || [];
                    const container = document.getElementById('projectTasksList');

                    if (!tasks || tasks.length === 0) {
                        container.innerHTML = '<p>Задач нет</p>';
                        return;
                    }

                    // Показываем только основные задачи (без родительских задач)
                    const mainTasks = tasks.filter(task => task.parent_task_id === null);

                    container.innerHTML = mainTasks.map(task => `
                        <div style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; cursor: pointer;"
                             onclick="App.openTask(${task.id})">
                            <div style="font-weight: bold;">${this.escapeHtml(task.title)}</div>
                            <div style="color: #666; font-size: 14px;">
                                Статус: ${this.getStatusText(task.status)} |
                                Приоритет: ${this.getPriorityText(task.priority)}
                                ${task.due_date ? `| Срок: ${new Date(task.due_date).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading project tasks:', error);
                    document.getElementById('projectTasksList').innerHTML = '<p>Ошибка загрузки задач</p>';
                }
            }

            static async openTask(taskId) {
                try {
                    console.log('Opening task:', taskId);

                    const response = await ApiService.getTask(taskId);
                    currentTask = response.task || response;
                    console.log('Current task set to:', currentTask);

                    if (!currentTask) {
                        this.showError('Задача не найдена');
                        return;
                    }

                    // Обновляем основную информацию
                    document.getElementById('taskTitleHeader').textContent = currentTask.title;
                    document.getElementById('taskDescriptionText').textContent = currentTask.description || 'Без описания';
                    document.getElementById('taskPriorityText').textContent = this.getPriorityText(currentTask.priority);
                    document.getElementById('taskCreatedAtText').textContent = new Date(currentTask.created_at).toLocaleString();
                    document.getElementById('taskDueDateText').textContent = currentTask.due_date ? new Date(currentTask.due_date).toLocaleDateString() : 'Не установлен';

                    if (currentTask.assigned_to_id) {
                        if (currentTask.assigned_user) {
                            const displayName = currentTask.assigned_user.full_name ||
                                              currentTask.assigned_user.username ||
                                              `Участник #${currentTask.assigned_to_id}`;
                            document.getElementById('taskAssignedToText').textContent = displayName;
                        } else {
                            await this.loadTaskAssigneeInfo(currentTask.assigned_to_id);
                        }
                    } else {
                        document.getElementById('taskAssignedToText').textContent = 'Не назначена';
                    }

                    // Устанавливаем статус
                    document.getElementById('taskStatusSelect').value = currentTask.status;

                    // Показываем/скрываем секцию подзадач и кнопку создания подзадач
                    const subtasksSection = document.getElementById('subtasksSection');
                    const createSubtaskBtn = document.getElementById('createSubtaskBtn');
                    if (currentTask.parent_task_id === null) {
                        subtasksSection.style.display = 'block';
                        createSubtaskBtn.style.display = 'block';
                        await this.loadSubtasks(currentTask.id);
                    } else {
                        subtasksSection.style.display = 'none';
                        createSubtaskBtn.style.display = 'none';
                    }

                    // Загружаем комментарии
                    await this.loadTaskComments(taskId);

                    // Загружаем зависимости
                    await this.loadTaskDependencies(taskId);

                    // Загружаем список задач для добавления зависимостей
                    await this.loadAvailableDependencies(taskId);

                    // Показываем вью задачи
                    this.showView('taskView');

                } catch (error) {
                    console.error('Error opening task:', error);
                    this.showError('Ошибка открытия задачи: ' + error.message);
                }
            }

            static async loadTaskAssigneeInfo(assigneeId) {
                try {
                    console.log('Loading assignee info for:', assigneeId);

                    // Если у нас есть данные о проекте и участниках, ищем исполнителя среди участников
                    if (currentProject && currentProject.members) {
                        console.log('Searching in project members:', currentProject.members);
                        const assignee = currentProject.members.find(member => {
                            const memberId = member.user_id || (member.user && member.user.id);
                            console.log('Checking member:', memberId, 'against assignee:', assigneeId);
                            return memberId === assigneeId;
                        });

                        if (assignee) {
                            console.log('Found assignee in members:', assignee);
                            const displayName = (assignee.user && assignee.user.full_name) ||
                                              assignee.full_name ||
                                              `Участник #${assigneeId}`;
                            document.getElementById('taskAssignedToText').textContent = displayName;
                            return;
                        }
                    }

                    // Если не нашли в участниках, попробуем загрузить участников проекта
                    if (currentProject && currentProject.hash) {
                        console.log('Loading project members for assignee search');
                        const projectResponse = await ApiService.getProject(currentProject.hash);
                        const projectMembers = projectResponse.members || [];

                        const assignee = projectMembers.find(member => {
                            const memberId = member.user_id || (member.user && member.user.id);
                            return memberId === assigneeId;
                        });

                        if (assignee) {
                            const displayName = (assignee.user && assignee.user.full_name) ||
                                              assignee.full_name ||
                                              `Участник #${assigneeId}`;
                            document.getElementById('taskAssignedToText').textContent = displayName;
                            return;
                        }
                    }

                    // Если все еще не нашли, показываем ID
                    console.log('Assignee not found, showing ID');
                    document.getElementById('taskAssignedToText').textContent = `ID: ${assigneeId}`;

                } catch (error) {
                    console.error('Error loading assignee info:', error);
                    document.getElementById('taskAssignedToText').textContent = `ID: ${assigneeId}`;
                }
            }

            static async loadSubtasks(parentTaskId) {
                try {
                    // ИСПРАВЛЕНО: Проверяем наличие currentProject
                    if (!currentProject || !currentProject.hash) {
                        console.error('No current project for loading subtasks');
                        document.getElementById('subtasksList').innerHTML = '<p>Ошибка загрузки подзадач: проект не выбран</p>';
                        return;
                    }

                    // Получаем все задачи проекта и фильтруем подзадачи
                    const response = await ApiService.getTasks(currentProject.hash);
                    const tasks = response.tasks || [];

                    const subtasks = tasks.filter(task => task.parent_task_id === parentTaskId);
                    const container = document.getElementById('subtasksList');

                    if (subtasks.length === 0) {
                        container.innerHTML = '<p>Подзадач нет</p>';
                        return;
                    }

                    container.innerHTML = subtasks.map(subtask => `
                        <div style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer;"
                             onclick="App.openTask(${subtask.id})">
                            <input type="checkbox" ${subtask.status === 'done' ? 'checked' : ''}
                                   onchange="App.toggleSubtaskStatus(${subtask.id}, this.checked)"
                                   style="cursor: pointer;"
                                   onclick="event.stopPropagation()">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${this.escapeHtml(subtask.title)}</div>
                                <!-- Описание не отображается для подзадач -->
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${this.getStatusText(subtask.status)}
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading subtasks:', error);
                    document.getElementById('subtasksList').innerHTML = '<p>Ошибка загрузки подзадач</p>';
                }
            }

            static async toggleSubtaskStatus(taskId, isDone) {
                try {
                    const newStatus = isDone ? 'done' : 'todo';
                    await ApiService.updateTaskStatus(taskId, newStatus);
                    this.showSuccess('Статус подзадачи обновлен!');
                } catch (error) {
                    console.error('Error updating subtask status:', error);
                    this.showError('Ошибка обновления статуса подзадачи: ' + error.message);
                }
            }

            static async loadTaskComments(taskId) {
                try {
                    const response = await ApiService.getTaskComments(taskId);
                    const comments = response.comments || [];
                    const container = document.getElementById('taskCommentsList');

                    if (!comments || comments.length === 0) {
                        container.innerHTML = '<p>Комментариев нет</p>';
                        return;
                    }

                    container.innerHTML = comments.map(comment => `
                        <div style="padding: 10px; border-bottom: 1px solid #ccc;">
                            <div style="font-weight: bold;">${this.escapeHtml(comment.author_name || 'Аноним')}</div>
                            <div style="color: #666;">${this.escapeHtml(comment.content)}</div>
                            <div style="font-size: 12px; color: #999;">${new Date(comment.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading task comments:', error);
                    document.getElementById('taskCommentsList').innerHTML = '<p>Ошибка загрузки комментариев</p>';
                }
            }

            // Загрузка зависимостей задачи
            static async loadTaskDependencies(taskId) {
                try {
                    const response = await ApiService.getTaskDependencies(taskId);
                    const dependencies = response.dependencies || [];
                    const dependents = response.dependents || [];

                    const dependenciesContainer = document.getElementById('taskDependenciesList');
                    const dependentsContainer = document.getElementById('taskDependentsList');

                    // Отображаем зависимости (задачи, от которых зависит текущая)
                    if (!dependencies || dependencies.length === 0) {
                        dependenciesContainer.innerHTML = '<p>Нет зависимостей</p>';
                    } else {
                        dependenciesContainer.innerHTML = `
                            <h4>Зависит от:</h4>
                            ${dependencies.map(dep => `
                                <div style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; cursor: pointer;" onclick="App.openTask(${dep.id})">
                                            ${this.escapeHtml(dep.title)}
                                        </div>
                                        <div style="font-size: 12px; color: #666;">
                                            Статус: ${this.getStatusText(dep.status)} |
                                            Приоритет: ${this.getPriorityText(dep.priority)}
                                        </div>
                                    </div>
                                    <button onclick="App.removeTaskDependency(${taskId}, ${dep.id})"
                                            style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        Удалить
                                    </button>
                                </div>
                            `).join('')}
                        `;
                    }

                    // Отображаем зависимые задачи (задачи, которые зависят от текущей)
                    if (!dependents || dependents.length === 0) {
                        dependentsContainer.innerHTML = '<p>Нет зависимых задач</p>';
                    } else {
                        dependentsContainer.innerHTML = `
                            <h4>Зависят от этой задачи:</h4>
                            ${dependents.map(dep => `
                                <div style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                                    <div style="font-weight: bold; cursor: pointer;" onclick="App.openTask(${dep.id})">
                                        ${this.escapeHtml(dep.title)}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        Статус: ${this.getStatusText(dep.status)} |
                                        Приоритет: ${this.getPriorityText(dep.priority)}
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    }

                } catch (error) {
                    console.error('Error loading task dependencies:', error);
                    document.getElementById('taskDependenciesList').innerHTML = '<p>Ошибка загрузки зависимостей</p>';
                    document.getElementById('taskDependentsList').innerHTML = '';
                }
            }

            // Загрузка доступных задач для добавления зависимостей
            static async loadAvailableDependencies(taskId) {
                try {
                    // ИСПРАВЛЕНО: Проверяем наличие currentProject
                    if (!currentProject || !currentProject.hash) {
                        console.error('No current project for loading dependencies');
                        return;
                    }

                    const response = await ApiService.getTasks(currentProject.hash);
                    const tasks = response.tasks || [];

                    // Исключаем текущую задачу и уже добавленные зависимости
                    const availableTasks = tasks.filter(task =>
                        task.id !== taskId &&
                        task.parent_task_id === null // Только основные задачи
                    );

                    const select = document.getElementById('addDependencySelect');
                    select.innerHTML = '<option value="">Выберите задачу для добавления зависимости</option>';

                    availableTasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = `${task.title} (${this.getStatusText(task.status)})`;
                        select.appendChild(option);
                    });

                } catch (error) {
                    console.error('Error loading available dependencies:', error);
                }
            }

            // Добавление зависимости
            static async addTaskDependency() {
                if (!currentTask || !currentTask.id) return;

                const select = document.getElementById('addDependencySelect');
                const dependsOnId = select.value;

                if (!dependsOnId) {
                    this.showError('Выберите задачу для добавления зависимости');
                    return;
                }

                try {
                    await ApiService.addTaskDependency(currentTask.id, dependsOnId);
                    this.showSuccess('Зависимость добавлена!');

                    // Обновляем списки зависимостей
                    await this.loadTaskDependencies(currentTask.id);
                    await this.loadAvailableDependencies(currentTask.id);

                    // Сбрасываем выбор
                    select.value = '';

                } catch (error) {
                    console.error('Error adding task dependency:', error);
                    this.showError('Ошибка добавления зависимости: ' + error.message);
                }
            }

            // Удаление зависимости
            static async removeTaskDependency(taskId, dependsOnId) {
                try {
                    await ApiService.removeTaskDependency(taskId, dependsOnId);
                    this.showSuccess('Зависимость удалена!');

                    // Обновляем списки зависимостей
                    await this.loadTaskDependencies(taskId);
                    await this.loadAvailableDependencies(taskId);

                } catch (error) {
                    console.error('Error removing task dependency:', error);
                    this.showError('Ошибка удаления зависимости: ' + error.message);
                }
            }

            static async showProjectMembersManagement() {
                if (!currentProject) return;

                try {
                    const response = await ApiService.getProjectMembers(currentProject.hash);
                    const members = response.members || [];
                    const container = document.getElementById('projectMembersManagementList');

                    // Получаем текущую роль пользователя
                    const projectData = await ApiService.getProject(currentProject.hash);
                    const userRole = projectData.current_user_role || currentProject.current_user_role;

                    console.log('User role in member management:', userRole);

                    if (!members || members.length === 0) {
                        container.innerHTML = '<p>Участников нет</p>';
                    } else {
                        // Правильная проверка прав доступа
                        const isOwner = userRole === ProjectRole.OWNER;
                        const isAdmin = userRole === ProjectRole.ADMIN;

                        // Владелец может управлять всеми, администраторы - только участниками
                        const canManageAll = isOwner;
                        const canManageMembers = isAdmin; // Админы могут управлять обычными участниками

                        console.log('User can manage all:', canManageAll);
                        console.log('User can manage members:', canManageMembers);

                        container.innerHTML = members.map(member => {
                            // Правильное получение данных участника
                            const memberData = member.user || member;
                            const displayName = (memberData.full_name && memberData.full_name.trim() !== '')
                                ? memberData.full_name
                                : (member.full_name && member.full_name.trim() !== '')
                                ? member.full_name
                                : `Участник #${member.user_id || memberData.id}`;

                            const isCurrentUser = (member.user_id || memberData.id) === currentUser.id;
                            const isOwnerMember = member.role === ProjectRole.OWNER;
                            const isAdminMember = member.role === ProjectRole.ADMIN;

                            // Определяем доступные действия
                            let canChangeRole = false;
                            let canRemove = false;

                            if (isOwner) {
                                // Владелец может изменять роли всех, кроме себя
                                canChangeRole = !isCurrentUser && !isOwnerMember;
                                canRemove = !isCurrentUser && !isOwnerMember;
                            } else if (isAdmin) {
                                // Администратор может изменять роли только участников (не админов и не владельца)
                                canChangeRole = !isCurrentUser && !isOwnerMember && !isAdminMember;
                                canRemove = !isCurrentUser && !isOwnerMember && !isAdminMember;
                            }

                            return `
                                <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: bold;">${this.escapeHtml(displayName)}</div>
                                            <div style="color: #666; font-size: 14px;">
                                                Роль: ${this.getRoleText(member.role)}
                                                ${isCurrentUser ? ' (Вы)' : ''}
                                                ${isOwnerMember ? ' ⭐ Владелец' : ''}
                                                ${isAdminMember && !isOwnerMember ? ' 🔧 Администратор' : ''}
                                            </div>
                                        </div>
                                        ${(canChangeRole || canRemove) ? `
                                        <div style="display: flex; gap: 10px;">
                                            ${canChangeRole ? `
                                            <button onclick="App.showUpdateMemberRoleModal(${member.user_id || memberData.id}, '${this.escapeHtml(displayName)}', '${member.role}')"
                                                    style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Изменить роль
                                            </button>
                                            ` : ''}
                                            ${canRemove ? `
                                            <button onclick="App.showRemoveMemberModal(${member.user_id || memberData.id}, '${this.escapeHtml(displayName)}')"
                                                    style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Удалить
                                            </button>
                                            ` : ''}
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    this.showView('projectMembersView');

                } catch (error) {
                    console.error('Error loading project members management:', error);
                    this.showError('Ошибка загрузки управления участниками: ' + error.message);
                }
            }

            static debugProjectData() {
                console.log('=== DEBUG PROJECT DATA ===');
                console.log('Current Project:', currentProject);
                console.log('Current User:', currentUser);

                if (currentProject) {
                    const projectData = ApiService.getProject(currentProject.hash);
                    console.log('Fresh Project Data:', projectData);
                }
            }

            static async showJoinRequests() {
                if (!currentProject) return;
                try {
                    const response = await ApiService.getProjectJoinRequests(currentProject.hash);
                    const joinRequests = response.requests || [];
                    const container = document.getElementById('joinRequestsList');

                    if (!joinRequests || joinRequests.length === 0) {
                        container.innerHTML = '<p>Заявок на вступление нет</p>';
                    } else {
                        container.innerHTML = joinRequests.map(request => {
                            const userData = request.user || request;
                            const displayName = (userData.full_name && userData.full_name.trim() !== '')
                                ? userData.full_name
                                : (request.user_full_name && request.user_full_name.trim() !== '')
                                ? request.user_full_name
                                : `Пользователь #${request.user_id || userData.id}`;

                            const requestDate = request.requested_at || request.created_at;
                            const formattedDate = requestDate ? new Date(requestDate).toLocaleString() : 'Дата не указана';

                            // Определяем статус и доступные действия
                            const statusText = this.getJoinRequestStatusText(request.status);
                            const statusColor = this.getJoinRequestStatusColor(request.status);
                            const canApprove = request.status === 'pending';
                            const canReject = request.status === 'pending';

                            return `
                                <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold;">${this.escapeHtml(displayName)}</div>
                                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                                Заявка подана: ${formattedDate}
                                            </div>
                                            <div style="font-size: 14px;">
                                                Статус: <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                                            </div>
                                            ${request.processed_at ? `
                                            <div style="color: #666; font-size: 12px;">
                                                Обработана: ${new Date(request.processed_at).toLocaleString()}
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            ${canApprove ? `
                                            <button onclick="App.approveJoinRequest(${request.id})"
                                                    style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Одобрить
                                            </button>
                                            ` : ''}
                                            ${canReject ? `
                                            <button onclick="App.rejectJoinRequest(${request.id})"
                                                    style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Отклонить
                                            </button>
                                            ` : ''}
                                            ${request.status !== 'pending' ? `
                                            <button onclick="App.removeProcessedRequest(${request.id})"
                                                    style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                Удалить
                                            </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    this.showView('joinRequestsView');
                } catch (error) {
                    console.error('Error loading join requests:', error);
                    this.showError('Ошибка загрузки заявок: ' + error.message);
                }
            }

            // Добавьте вспомогательные методы для статусов заявок
            static getJoinRequestStatusText(status) {
                const statusMap = {
                    'pending': 'Ожидает рассмотрения',
                    'approved': 'Одобрена',
                    'rejected': 'Отклонена'
                };
                return statusMap[status] || status;
            }

            static getJoinRequestStatusColor(status) {
                const colorMap = {
                    'pending': '#ffc107',
                    'approved': '#28a745',
                    'rejected': '#dc3545'
                };
                return colorMap[status] || '#6c757d';
            }

            static async approveJoinRequest(requestId) {
                if (!currentProject) return;
                try {
                    console.log('Approving join request:', requestId, 'for project:', currentProject.hash);
                    await ApiService.approveJoinRequest(currentProject.hash, requestId);
                    this.showSuccess('Заявка одобрена!');
                    // Перезагружаем список заявок и участников
                    await this.showJoinRequests();
                    await this.loadProjectMembers(currentProject.hash);
                } catch (error) {
                    console.error('Error approving join request:', error);
                    if (error.message.includes('400')) {
                        if (error.message.includes('already')) {
                            this.showError('Заявка уже обработана ранее.');
                        } else if (error.message.includes('already a member')) {
                            this.showError('Пользователь уже является участником проекта.');
                        }
                        // Перезагружаем список заявок для обновления статусов
                        await this.showJoinRequests();
                    } else {
                        this.showError('Ошибка одобрения заявки: ' + error.message);
                    }
                }
            }

            static async removeProcessedRequest(requestId) {
                if (!currentProject) return;
                try {
                    if (confirm('Вы уверены, что хотите удалить эту заявку из списка?')) {
                        await ApiService.deleteJoinRequest(currentProject.hash, requestId);
                        this.showSuccess('Заявка удалена!');
                        await this.showJoinRequests();
                    }
                } catch (error) {
                    console.error('Error removing processed request:', error);
                    this.showError('Ошибка удаления заявки: ' + error.message);
                }
            }

            static async rejectJoinRequest(requestId) {
                if (!currentProject) return;
                try {
                    console.log('Rejecting join request:', requestId, 'for project:', currentProject.hash);
                    await ApiService.rejectJoinRequest(currentProject.hash, requestId);
                    this.showSuccess('Заявка отклонена!');
                    await this.showJoinRequests();
                } catch (error) {
                    console.error('Error rejecting join request:', error);
                    if (error.message.includes('400')) {
                        this.showError('Заявка уже обработана ранее.');
                        await this.showJoinRequests();
                    } else {
                        this.showError('Ошибка отклонения заявки: ' + error.message);
                    }
                }
            }


            static async rejectJoinRequest(requestId) {
                if (!currentProject) return;

                try {
                    console.log('Rejecting join request:', requestId, 'for project:', currentProject.hash);

                    await ApiService.rejectJoinRequest(currentProject.hash, requestId);
                    this.showSuccess('Заявка отклонена!');
                    await this.showJoinRequests(); // Перезагружаем список

                } catch (error) {
                    console.error('Error rejecting join request:', error);
                    if (error.message.includes('404')) {
                        this.showError('Заявка не найдена. Возможно, она уже была обработана.');
                    } else {
                        this.showError('Ошибка отклонения заявки: ' + error.message);
                    }
                }
            }

            static async refreshProjectData() {
                if (!currentProject || !currentProject.hash) return;

                try {
                    const projectData = await ApiService.getProject(currentProject.hash);
                    currentProject = projectData.project || projectData;
                    currentProject.members = projectData.members || [];

                    console.log('Project data refreshed:', currentProject);
                } catch (error) {
                    console.error('Error refreshing project data:', error);
                }
            }

            static showUpdateMemberRoleModal(userId, userName, currentRole) {
                currentMemberToUpdate = { userId, userName, currentRole };
                document.getElementById('memberName').textContent = userName;

                const roleSelect = document.getElementById('memberRoleSelect');

                // Получаем текущую роль пользователя
                const currentUserRole = currentProject.current_user_role;

                // Если пользователь администратор (не владелец), ограничиваем доступные роли
                if (currentUserRole === 'admin') {
                    roleSelect.innerHTML = `
                        <option value="member">Участник</option>
                        <option value="guest">Гость</option>
                    `;
                } else {
                    // Владелец может назначать любые роли
                    roleSelect.innerHTML = `
                        <option value="admin">Администратор</option>
                        <option value="member">Участник</option>
                        <option value="guest">Гость</option>
                    `;
                }

                roleSelect.value = currentRole;
                this.showModal('updateMemberRoleModal');
            }

            static async handleUpdateMemberRole() {
                if (!currentProject || !currentMemberToUpdate) return;

                try {
                    const newRole = document.getElementById('memberRoleSelect').value;
                    await ApiService.updateMemberRole(currentProject.hash, currentMemberToUpdate.userId, newRole);

                    this.hideModal('updateMemberRoleModal');
                    this.showSuccess('Роль участника обновлена!');
                    await this.showProjectMembersManagement(); // Перезагружаем список

                } catch (error) {
                    console.error('Error updating member role:', error);
                    this.showError('Ошибка обновления роли: ' + error.message);
                }
            }

            static showRemoveMemberModal(userId, userName) {
                currentMemberToRemove = { userId, userName };
                document.getElementById('removeMemberName').textContent = userName;
                this.showModal('removeMemberModal');
            }

            static async handleRemoveMember() {
                if (!currentProject || !currentMemberToRemove) return;

                try {
                    await ApiService.removeProjectMember(currentProject.hash, currentMemberToRemove.userId);

                    this.hideModal('removeMemberModal');
                    this.showSuccess('Участник удален из проекта!');
                    await this.showProjectMembersManagement(); // Перезагружаем список

                } catch (error) {
                    console.error('Error removing member:', error);
                    if (error.message.includes('403')) {
                        this.showError('Недостаточно прав для удаления участника');
                    } else {
                        this.showError('Ошибка удаления участника: ' + error.message);
                    }
                }
            }

            static async showCreateTaskModal() {
                if (!currentProject) return;

                try {
                    // Загружаем участников проекта
                    const response = await ApiService.getProjectMembers(currentProject.hash);
                    const members = response.members || [];

                    const assignedToSelect = document.getElementById('taskAssignedTo');
                    assignedToSelect.innerHTML = '<option value="">Не назначена</option>';

                    members.forEach(member => {
                        // ИСПРАВЛЕНО: Правильное получение имени участника
                        const memberData = member.user || member;
                        const displayName = memberData.full_name && memberData.full_name.trim() !== ''
                            ? memberData.full_name
                            : `Участник #${member.user_id || memberData.id}`;

                        const option = document.createElement('option');
                        option.value = member.user_id || memberData.id;
                        option.textContent = displayName;
                        assignedToSelect.appendChild(option);
                    });

                    // Загружаем задачи для выбора родительской задачи
                    const tasksResponse = await ApiService.getTasks(currentProject.hash);
                    const tasks = tasksResponse.tasks || [];

                    const parentTaskSelect = document.getElementById('taskParentId');
                    parentTaskSelect.innerHTML = '<option value="">Основная задача (без родителя)</option>';

                    tasks.forEach(task => {
                        // Показываем только основные задачи как возможных родителей
                        if (task.parent_task_id === null) {
                            const option = document.createElement('option');
                            option.value = task.id;
                            option.textContent = task.title;
                            parentTaskSelect.appendChild(option);
                        }
                    });

                    this.showModal('createTaskModal');

                } catch (error) {
                    console.error('Error loading task creation data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            static async showCreateSubtaskModal() {
                if (!currentProject || !currentTask) return;

                try {
                    // Загружаем участников проекта
                    const response = await ApiService.getProjectMembers(currentProject.hash);
                    const members = response.members || [];

                    const assignedToSelect = document.getElementById('subtaskAssignedTo');
                    assignedToSelect.innerHTML = '<option value="">Не назначена</option>';

                    members.forEach(member => {
                        // ИСПРАВЛЕНО: Правильное получение имени участника
                        const memberData = member.user || member;
                        const displayName = memberData.full_name && memberData.full_name.trim() !== ''
                            ? memberData.full_name
                            : `Участник #${member.user_id || memberData.id}`;

                        const option = document.createElement('option');
                        option.value = member.user_id || memberData.id;
                        option.textContent = displayName;
                        assignedToSelect.appendChild(option);
                    });

                    // Устанавливаем родительскую задачу
                    document.getElementById('subtaskTitle').value = '';
                    document.getElementById('subtaskDescription').value = ''; // Пустое описание
                    document.getElementById('subtaskPriority').value = currentTask.priority || 'medium';

                    // Устанавливаем срок выполнения как у родительской задачи
                    if (currentTask.due_date) {
                        const dueDate = new Date(currentTask.due_date);
                        document.getElementById('subtaskDueDate').value = dueDate.toISOString().split('T')[0];
                    } else {
                        document.getElementById('subtaskDueDate').value = '';
                    }

                    this.showModal('createSubtaskModal');

                } catch (error) {
                    console.error('Error loading subtask creation data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            static async handleCreateSubtask() {
                if (!currentProject || !currentTask) return;

                const title = document.getElementById('subtaskTitle').value.trim();
                const description = "";
                const priority = currentTask.priority || 'medium';
                const dueDate = currentTask.due_date || null;
                const assignedTo = document.getElementById('subtaskAssignedTo').value;

                if (!title) {
                    this.showError('Введите название подзадачи');
                    return;
                }

                try {
                    const taskData = {
                        title,
                        description,
                        project_hash: currentProject.hash,
                        priority,
                        status: 'todo',
                        parent_task_id: currentTask.id
                    };

                    if (dueDate) {
                        taskData.due_date = dueDate;
                    }

                    // ИСПРАВЛЕНО: используем assigned_to_id вместо assigned_to_ids
                    if (assignedTo) {
                        taskData.assigned_to_id = parseInt(assignedTo);
                    }

                    console.log('Creating subtask with data:', taskData);
                    await ApiService.createTask(taskData);

                    this.hideModal('createSubtaskModal');
                    document.getElementById('createSubtaskForm').reset();

                    await this.loadSubtasks(currentTask.id);
                    this.showSuccess('Подзадача создана успешно!');

                } catch (error) {
                    console.error('Error creating subtask:', error);
                    this.showError('Ошибка создания подзадачи: ' + error.message);
                }
            }

            static async handleCreateTask() {
                if (!currentProject) return;

                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const priority = document.getElementById('taskPriority').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const parentTaskId = document.getElementById('taskParentId').value;
                const assignedTo = document.getElementById('taskAssignedTo').value;

                if (!title) {
                    this.showError('Введите название задачи');
                    return;
                }

                try {
                    const taskData = {
                        title,
                        description,
                        project_hash: currentProject.hash,
                        priority,
                        status: 'todo'
                    };

                    if (dueDate) taskData.due_date = dueDate;
                    if (parentTaskId) taskData.parent_task_id = parseInt(parentTaskId);

                    // ИСПРАВЛЕНО: используем assigned_to_id вместо assigned_to_ids
                    if (assignedTo) {
                        taskData.assigned_to_id = parseInt(assignedTo);
                    }

                    console.log('Creating task with data:', taskData);
                    await ApiService.createTask(taskData);

                    this.hideModal('createTaskModal');

                    // ИСПРАВЛЕНО: Проверяем существование формы перед reset
                    const createTaskForm = document.getElementById('createTaskForm');
                    if (createTaskForm) {
                        createTaskForm.reset();
                    }

                    // Перезагружаем задачи проекта
                    await this.loadProjectTasks(currentProject.hash);
                    this.showSuccess('Задача создана успешно!');

                } catch (error) {
                    console.error('Error creating task:', error);
                    this.showError('Ошибка создания задачи: ' + error.message);
                }
            }

            static showEditTaskModal() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for editing:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                // ИСПРАВЛЕНО: Проверяем существование элементов перед установкой значений
                const editTaskTitle = document.getElementById('editTaskTitle');
                const editTaskDescription = document.getElementById('editTaskDescription');
                const editTaskPriority = document.getElementById('editTaskPriority');
                const editTaskDueDate = document.getElementById('editTaskDueDate');

                if (editTaskTitle) editTaskTitle.value = currentTask.title;
                if (editTaskDescription) editTaskDescription.value = currentTask.description || '';
                if (editTaskPriority) editTaskPriority.value = currentTask.priority;

                if (editTaskDueDate) {
                    if (currentTask.due_date) {
                        const dueDate = new Date(currentTask.due_date);
                        editTaskDueDate.value = dueDate.toISOString().split('T')[0];
                    } else {
                        editTaskDueDate.value = '';
                    }
                }

                this.showModal('editTaskModal');
            }

            static async handleUpdateTask() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for update:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                const title = document.getElementById('editTaskTitle').value.trim();
                const description = document.getElementById('editTaskDescription').value.trim();
                const priority = document.getElementById('editTaskPriority').value;
                const dueDate = document.getElementById('editTaskDueDate').value;

                if (!title) {
                    this.showError('Введите название задачи');
                    return;
                }

                try {
                    const taskData = {
                        title,
                        description,
                        priority
                    };

                    if (dueDate) {
                        taskData.due_date = dueDate;
                    } else {
                        taskData.due_date = null;
                    }

                    // ИСПРАВЛЕНО: если нужно обновить назначение, используем assigned_to_id
                    // (можно добавить поле в форму редактирования)

                    console.log('Updating task:', currentTask.id, taskData);
                    await ApiService.updateTask(currentTask.id, taskData);

                    this.hideModal('editTaskModal');
                    await this.openTask(currentTask.id);
                    this.showSuccess('Задача обновлена успешно!');

                } catch (error) {
                    console.error('Error updating task:', error);
                    this.showError('Ошибка обновления задачи: ' + error.message);
                }
            }

            static async assignTaskToUser(userId) {
                if (!currentTask || !currentTask.id) return;

                try {
                    const taskData = {
                        assigned_to_id: userId
                    };

                    await ApiService.updateTask(currentTask.id, taskData);
                    this.showSuccess('Исполнитель назначен!');
                    await this.openTask(currentTask.id); // Перезагружаем задачу

                } catch (error) {
                    console.error('Error assigning task:', error);
                    this.showError('Ошибка назначения исполнителя: ' + error.message);
                }
            }

            static showDeleteTaskModal() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for deletion:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                // ИСПРАВЛЕНО: Проверяем существование элемента
                const deleteTaskName = document.getElementById('deleteTaskName');
                if (deleteTaskName) {
                    deleteTaskName.textContent = currentTask.title;
                }

                this.showModal('deleteTaskModal');
            }

            static async handleDeleteTask() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for deletion:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                try {
                    console.log('Deleting task:', currentTask.id);
                    await ApiService.deleteTask(currentTask.id);

                    this.hideModal('deleteTaskModal');
                    this.backToProject();
                    this.showSuccess('Задача удалена успешно!');

                } catch (error) {
                    console.error('Error deleting task:', error);
                    this.showError('Ошибка удаления задачи: ' + error.message);
                }
            }

            static async updateTaskStatus() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task or task ID:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                try {
                    const newStatus = document.getElementById('taskStatusSelect').value;
                    console.log('Updating task status:', currentTask.id, newStatus);

                    await ApiService.updateTaskStatus(currentTask.id, newStatus);

                    currentTask.status = newStatus;
                    this.showSuccess('Статус задачи обновлен!');

                } catch (error) {
                    console.error('Error updating task status:', error);
                    this.showError('Ошибка обновления статуса: ' + error.message);
                    // Восстанавливаем предыдущее значение
                    if (currentTask) {
                        document.getElementById('taskStatusSelect').value = currentTask.status;
                    }
                }
            }

            static async addComment() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for comment:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                const content = document.getElementById('newCommentText').value.trim();
                if (!content) {
                    this.showError('Введите текст комментария');
                    return;
                }

                try {
                    await ApiService.createTaskComment(currentTask.id, content);

                    document.getElementById('newCommentText').value = '';
                    await this.loadTaskComments(currentTask.id);
                    this.showSuccess('Комментарий добавлен!');

                } catch (error) {
                    console.error('Error adding comment:', error);
                    this.showError('Ошибка добавления комментария: ' + error.message);
                }
            }

            static showEditProjectModal() {
                if (!currentProject) return;

                document.getElementById('editProjectTitle').value = currentProject.title;
                document.getElementById('editProjectDescription').value = currentProject.description || '';
                document.getElementById('editProjectIsPrivate').checked = currentProject.is_private;
                document.getElementById('editProjectRequiresApproval').checked = currentProject.requires_approval;

                this.showModal('editProjectModal');
            }

            static async handleUpdateProject() {
                if (!currentProject) return;

                const title = document.getElementById('editProjectTitle').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const isPrivate = document.getElementById('editProjectIsPrivate').checked;
                const requiresApproval = document.getElementById('editProjectRequiresApproval').checked;

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    await ApiService.updateProject(currentProject.hash, {
                        title,
                        description,
                        is_private: isPrivate,
                        requires_approval: requiresApproval
                    });

                    this.hideModal('editProjectModal');
                    await this.openProject(currentProject.hash); // Перезагружаем проект
                    this.showSuccess('Проект обновлен успешно!');

                } catch (error) {
                    console.error('Error updating project:', error);
                    this.showError('Ошибка обновления проекта: ' + error.message);
                }
            }

            static showDeleteProjectModal() {
                if (!currentProject) return;

                document.getElementById('deleteProjectName').textContent = currentProject.title;
                this.showModal('deleteProjectModal');
            }

            static async handleDeleteProject() {
                if (!currentProject) return;

                try {
                    await ApiService.deleteProject(currentProject.hash);

                    this.hideModal('deleteProjectModal');
                    this.showDashboard();
                    this.showSuccess('Проект удален успешно!');

                } catch (error) {
                    console.error('Error deleting project:', error);
                    this.showError('Ошибка удаления проекта: ' + error.message);
                }
            }

            static async handleCreateProject() {
                const title = document.getElementById('projectTitle').value.trim();
                const description = document.getElementById('projectDescription').value.trim();
                const isPrivate = document.getElementById('projectIsPrivate').checked;
                const requiresApproval = document.getElementById('projectRequiresApproval').checked;

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    console.log('Creating project:', { title, description, isPrivate, requiresApproval });

                    await ApiService.createProject({
                        title,
                        description,
                        is_private: isPrivate,
                        requires_approval: requiresApproval
                    });

                    // Закрываем модальное окно
                    this.hideModal('createProjectModal');

                    // Очищаем форму
                    document.getElementById('createProjectForm').reset();

                    // Перезагружаем данные
                    await this.loadData();

                    this.showSuccess('Проект создан успешно!');

                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showError('Ошибка создания проекта: ' + error.message);
                }
            }

            static async searchProjects() {
                const searchTerm = document.getElementById('searchProjectsInput').value.trim();

                try {
                    if (!searchTerm) {
                        await this.loadRecentPublicProjects();
                        return;
                    }

                    // Если поисковый запрос похож на хэш (только буквы и цифры, длина 6+ символов), пробуем поиск по хэшу
                    if (/^[a-zA-Z0-9]{6,}$/.test(searchTerm)) {
                        try {
                            await this.searchProjectByExactHash(searchTerm);
                            return; // Если нашли по хэшу, выходим
                        } catch (error) {
                            console.log('Project not found by hash, trying by name...');
                            // Если не нашли по хэшу, продолжаем поиск по названию
                            await this.searchProjectsByQuery(searchTerm);
                        }
                    } else {
                        // Поиск только по названию
                        await this.searchProjectsByQuery(searchTerm);
                    }
                } catch (error) {
                    console.error('Error searching projects:', error);
                    this.showError('Ошибка поиска проектов: ' + error.message);
                }
            }

            static async searchProjectByExactHash(hash) {
                try {
                    const response = await ApiService.getProjectByHashExact(hash);
                    const project = response.project;

                    if (project) {
                        // Показываем найденный проект
                        this.renderSearchResults([project], `Найден проект по хэшу: ${hash}`, response);
                    } else {
                        throw new Error('Project not found');
                    }
                } catch (error) {
                    if (error.message.includes('404')) {
                        document.getElementById('searchResultsList').innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <p>Проект с хэшем "${hash}" не найден</p>
                                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                    Проверьте правильность хэша или попробуйте поиск по названию
                                </p>
                                <button onclick="App.searchProjectsByQuery('${hash}')"
                                        style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                    Искать по названию
                                </button>
                            </div>
                        `;
                    } else {
                        throw error;
                    }
                }
            }

            static async searchProjectsByQuery(query) {
                try {
                    const response = await ApiService.searchPublicProjects(query);
                    const projects = response.projects || [];
                    const title = query ? `Результаты поиска по названию: "${query}"` : 'Публичные проекты';
                    this.renderSearchResults(projects, title);
                } catch (error) {
                    console.error('Error searching projects by query:', error);
                    document.getElementById('searchResultsList').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p>Ошибка поиска проектов</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                ${error.message}
                            </p>
                        </div>
                    `;
                }
            }

            static renderSearchResults(projects, title, exactMatchData = null) {
                const container = document.getElementById('searchResultsList');

                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p>Проекты не найдены</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                Попробуйте изменить поисковый запрос или создать новый проект
                            </p>
                        </div>
                    `;
                    return;
                }

                let html = `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0;">${title}</h3>
                    ${exactMatchData ? '<span class="search-type-badge">По хэшу</span>' : '<span class="search-type-badge">По названию</span>'}
                </div>`;

                html += projects.map(project => {
                    const stats = project.stats || {};
                    const requiresApproval = project.requires_approval;
                    const isPrivate = project.is_private;

                    // Определяем текст и действие для кнопки
                    let buttonText = 'Присоединиться';
                    let buttonAction = `App.joinProject('${project.hash}')`;
                    let buttonClass = 'btn-primary';

                    if (isPrivate && requiresApproval) {
                        buttonText = 'Отправить заявку';
                        buttonClass = 'btn-warning';
                    } else if (isPrivate) {
                        buttonText = 'Запросить доступ';
                        buttonClass = 'btn-info';
                    }

                    // Если это точное совпадение по хэшу, проверяем возможность присоединения
                    if (exactMatchData && !exactMatchData.can_join) {
                        if (exactMatchData.is_member) {
                            buttonText = 'Вы уже в проекте';
                            buttonAction = `App.openProject('${project.hash}')`;
                            buttonClass = 'btn-success';
                        } else {
                            buttonText = 'Доступ закрыт';
                            buttonAction = '';
                            buttonClass = 'btn-secondary';
                            buttonClass += '" disabled';
                        }
                    }

                    return `
                        <div style="padding: 20px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">
                                        ${this.escapeHtml(project.title)}
                                    </div>
                                    <div style="color: #666; margin-bottom: 10px;">
                                        ${this.escapeHtml(project.description || 'Без описания')}
                                    </div>
                                    <div style="display: flex; gap: 15px; font-size: 14px; color: #888; margin-bottom: 10px; flex-wrap: wrap;">
                                        <span>Участников: ${stats.members_count || 0}</span>
                                        <span>Задач: ${stats.tasks_count || 0}</span>
                                        <span>Выполнено: ${stats.tasks_done || 0}</span>
                                        <span>Тип: ${isPrivate ? 'Приватный' : 'Публичный'}</span>
                                        ${isPrivate ? `<span>Одобрение: ${requiresApproval ? 'Требуется' : 'Не требуется'}</span>` : ''}
                                    </div>
                                    <div style="font-size: 12px; color: #999;">
                                        Создан: ${new Date(project.created_at).toLocaleDateString()}
                                        ${project.owner ? ` • Владелец: ${this.escapeHtml(project.owner.full_name)}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 10px; min-width: 150px;">
                                    <button onclick="${buttonAction}"
                                            style="padding: 8px 16px; background: ${this.getButtonColor(buttonClass)}; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                            ${buttonClass.includes('disabled') ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                    <button onclick="App.openProjectPreview('${project.hash}')"
                                            style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Подробнее
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            static getButtonColor(buttonClass) {
                const colorMap = {
                    'btn-primary': '#007bff',
                    'btn-warning': '#ffc107',
                    'btn-info': '#17a2b8',
                    'btn-success': '#28a745',
                    'btn-secondary': '#6c757d'
                };
                return colorMap[buttonClass] || '#007bff';
            }

            static async openProjectPreview(projectHash) {
                try {
                    const response = await ApiService.getProjectByHashExact(projectHash);
                    const project = response.project;

                    // Показываем модальное окно с информацией о проекте
                    this.showProjectPreviewModal(project, response);
                } catch (error) {
                    console.error('Error opening project preview:', error);
                    this.showError('Ошибка загрузки информации о проекте: ' + error.message);
                }
            }

            static showProjectPreviewModal(project, projectData) {
                const stats = project.stats || {};

                const modalHtml = `
                    <div id="projectPreviewModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 8px; min-width: 500px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">Информация о проекте</h3>
                                <button onclick="App.hideModal('projectPreviewModal')" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px; color: #333;">${this.escapeHtml(project.title)}</h4>
                                <p style="color: #666; margin-bottom: 15px;">${this.escapeHtml(project.description || 'Без описания')}</p>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 12px; color: #666;">Участников</div>
                                    <div style="font-size: 18px; font-weight: bold;">${stats.members_count || 0}</div>
                                </div>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 12px; color: #666;">Задач</div>
                                    <div style="font-size: 18px; font-weight: bold;">${stats.tasks_count || 0}</div>
                                </div>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 12px; color: #666;">Выполнено</div>
                                    <div style="font-size: 18px; font-weight: bold;">${stats.tasks_done || 0}</div>
                                </div>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 12px; color: #666;">Тип</div>
                                    <div style="font-size: 14px; font-weight: bold;">${project.is_private ? 'Приватный' : 'Публичный'}</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; color: #666;">
                                    <strong>Хэш проекта:</strong> ${project.hash}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                    <strong>Создан:</strong> ${new Date(project.created_at).toLocaleString()}
                                </div>
                                ${project.owner ? `
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                    <strong>Владелец:</strong> ${this.escapeHtml(project.owner.full_name)}
                                </div>
                                ` : ''}
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="App.hideModal('projectPreviewModal')"
                                        style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Закрыть
                                </button>
                                ${projectData.can_join ? `
                                <button onclick="App.joinProjectFromPreview('${project.hash}')"
                                        style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ${project.requires_approval ? 'Отправить заявку' : 'Присоединиться'}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Добавляем модальное окно в DOM
                if (!document.getElementById('projectPreviewModal')) {
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }
            }

            static joinProjectFromPreview(projectHash) {
                this.hideModal('projectPreviewModal');
                this.joinProject(projectHash);
            }

            static async joinProject(projectHash) {
                try {
                    const response = await ApiService.joinProject(projectHash);

                    if (response.status === 'joined') {
                        this.showSuccess('Вы успешно присоединились к проекту!');
                        // Открываем проект
                        await this.openProject(projectHash);
                    } else if (response.status === 'pending_approval') {
                        this.showSuccess('Заявка на вступление отправлена! Ожидайте одобрения.');
                        // Закрываем поиск и возвращаемся к дашборду
                        this.showDashboard();
                    }
                } catch (error) {
                    console.error('Error joining project:', error);
                    if (error.message.includes('400') && error.message.includes('already a member')) {
                        this.showError('Вы уже являетесь участником этого проекта');
                        await this.openProject(projectHash);
                    } else if (error.message.includes('400') && error.message.includes('already pending')) {
                        this.showError('Заявка на вступление уже отправлена');
                    } else {
                        this.showError('Ошибка вступления в проект: ' + error.message);
                    }
                }
            }

            static async showNotifications() {
                try {
                    const response = await ApiService.getNotifications();
                    const notifications = response.notifications || [];
                    const container = document.getElementById('notificationsList');

                    if (!container) {
                        console.error('Notifications container not found');
                        return;
                    }

                    if (!notifications || notifications.length === 0) {
                        container.innerHTML = '<p>Уведомлений нет</p>';
                    } else {
                        container.innerHTML = notifications.map(notification => `
                            <div style="padding: 10px; border-bottom: 1px solid #ccc;">
                                <div style="font-weight: bold;">${this.escapeHtml(notification.title || 'Уведомление')}</div>
                                <div style="color: #666;">${this.escapeHtml(notification.message || '')}</div>
                                <div style="font-size: 12px; color: #999;">${new Date(notification.created_at).toLocaleString()}</div>
                            </div>
                        `).join('');
                    }

                    this.showModal('notificationsModal');

                } catch (error) {
                    console.error('Error loading notifications:', error);
                    this.showError('Ошибка загрузки уведомлений: ' + error.message);
                }
            }

            static async markAllNotificationsRead() {
                try {
                    await ApiService.markAllNotificationsRead();
                    this.hideModal('notificationsModal');
                    this.showSuccess('Все уведомления отмечены как прочитанные!');
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                    this.showError('Ошибка отметки уведомлений: ' + error.message);
                }
            }

            static async showSettings() {
                try {
                    // Загружаем данные пользователя
                    const userData = await ApiService.getCurrentUser();
                    const preferences = await ApiService.getUserPreferences();

                    // Заполняем форму
                    document.getElementById('userFullName').value = userData.full_name || '';
                    document.getElementById('userUsername').value = userData.username || '';
                    document.getElementById('userTheme').value = preferences.theme || 'light';
                    document.getElementById('userNotificationsEnabled').checked = preferences.notifications_enabled;
                    document.getElementById('userCompactView').checked = preferences.compact_view;

                    this.showModal('settingsModal');

                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.showError('Ошибка загрузки настроек: ' + error.message);
                }
            }

            static async handleSaveSettings() {
                try {
                    const fullName = document.getElementById('userFullName').value.trim();
                    const username = document.getElementById('userUsername').value.trim();

                    // Обновляем данные пользователя
                    if (fullName || username) {
                        await ApiService.updateCurrentUser({
                            full_name: fullName,
                            username: username
                        });
                    }

                    // Обновляем настройки
                    await ApiService.updateUserPreferences({
                        theme: document.getElementById('userTheme').value,
                        notifications_enabled: document.getElementById('userNotificationsEnabled').checked,
                        compact_view: document.getElementById('userCompactView').checked
                    });

                    this.hideModal('settingsModal');
                    this.showSuccess('Настройки сохранены успешно!');

                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Ошибка сохранения настроек: ' + error.message);
                }
            }

            static async resetUserPreferences() {
                try {
                    await ApiService.resetUserPreferences();
                    this.hideModal('settingsModal');
                    this.showSuccess('Настройки сброшены к значениям по умолчанию!');
                } catch (error) {
                    console.error('Error resetting preferences:', error);
                    this.showError('Ошибка сброса настроек: ' + error.message);
                }
            }

            static backToProject() {
                console.log('Back to project, currentProject:', currentProject);
                if (currentProject && currentProject.hash) {
                    this.openProject(currentProject.hash);
                } else {
                    console.log('No current project, showing dashboard');
                    this.showDashboard();
                }
            }

            // Вспомогательные методы
            static getStatusText(status) {
                const statusMap = {
                    'todo': 'К выполнению',
                    'in_progress': 'В работе',
                    'done': 'Выполнено'
                };
                return statusMap[status] || status;
            }

            static getPriorityText(priority) {
                const priorityMap = {
                    'low': 'Низкий',
                    'medium': 'Средний',
                    'high': 'Высокий',
                    'urgent': 'Срочный'
                };
                return priorityMap[priority] || priority;
            }

            static getRoleText(role) {
                const roleMap = {
                    'owner': 'Владелец',
                    'admin': 'Администратор',
                    'member': 'Участник',
                    'guest': 'Гость'
                };
                return roleMap[role] || role;
            }

            static showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    console.error(`Modal with id '${modalId}' not found`);
                }
            }

            static hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            static showError(message) {
                alert('Ошибка: ' + message);
            }

            static showSuccess(message) {
                alert('Успех: ' + message);
            }

            static showInfo(message) {
                alert('Информация: ' + message);
            }

            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
