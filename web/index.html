<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pilot - Управление проектами</title>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
</head>
<body>
    <div id="loading" style="padding: 20px; text-align: center;">
        <p>Загрузка приложения...</p>
    </div>

    <div id="app" style="display: none;">
        <!-- Header -->
        <div style="padding: 10px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;">Project Pilot</h1>
            <div>
                <button id="createProjectBtn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать проект
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
            <!-- Dashboard -->
            <div id="dashboardView">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="projectsCount">0</div>
                        <div>Проектов</div>
                    </div>
                    <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="tasksCount">0</div>
                        <div>Задач</div>
                    </div>
                </div>

                <div>
                    <h2>Мои проекты</h2>
                    <div id="projectsList">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="createProjectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 4px; min-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Создать проект</h3>
                <button onclick="App.hideModal('createProjectModal')" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
            </div>
            <form id="createProjectForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Название проекта *</label>
                    <input type="text" id="projectTitle" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Описание</label>
                    <textarea id="projectDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="App.hideModal('createProjectModal')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Отмена
                </button>
                <button onclick="App.handleCreateProject()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Создать
                </button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация
        const CONFIG = {
            API_BASE_URL: 'https://powerfully-exotic-chamois.cloudpub.ru/api'
        };

        // Менеджер аутентификации
        class AuthManager {
            static async initialize() {
                try {
                    console.log('Initializing authentication...');

                    // Проверяем MAX окружение
                    if (typeof WebApp !== 'undefined' && WebApp.initDataUnsafe?.user) {
                        return await this.authenticateWithMax();
                    } else {
                        // Для разработки - тестовый пользователь
                        return await this.authenticateWithTestUser();
                    }
                } catch (error) {
                    console.error('Authentication failed:', error);
                    throw error;
                }
            }

            static async authenticateWithMax() {
                const userData = WebApp.initDataUnsafe.user;
                const maxId = userData.id.toString();
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Пользователь MAX';

                console.log('MAX authentication with:', { maxId, fullName });

                const tokenData = await ApiService.getAuthToken(maxId, fullName, userData.username || '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('MAX authentication successful');
                    return tokenData.user;
                }

                throw new Error('MAX authentication failed');
            }

            static async authenticateWithTestUser() {
                const testId = 'dev_user_' + Math.random().toString(36).substr(2, 9);
                const fullName = 'Тестовый пользователь';

                console.log('Test authentication with:', { testId, fullName });

                const tokenData = await ApiService.getAuthToken(testId, fullName, '');

                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('Test authentication successful');
                    return tokenData.user;
                }

                throw new Error('Test authentication failed');
            }

            static getToken() {
                return localStorage.getItem('access_token');
            }

            static isAuthenticated() {
                return !!this.getToken();
            }
        }

        // API сервис
        class ApiService {
            static async request(endpoint, options = {}) {
                const token = AuthManager.getToken();
                const url = `${CONFIG.API_BASE_URL}${endpoint}`;

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                console.log(`API Request: ${options.method || 'GET'} ${url}`);

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log(`API Response:`, data);
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            static async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            static async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            static async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            static async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }

            // Auth endpoints
            static async getAuthToken(maxId, fullName, username) {
                return this.post('/auth/token', {
                    max_id: maxId,
                    full_name: fullName,
                    username: username
                });
            }

            // Project endpoints
            static async getProjects() {
                return this.get('/projects/');
            }

            static async createProject(projectData) {
                return this.post('/projects/', projectData);
            }

            static async getProject(projectHash) {
                return this.get(`/projects/${projectHash}`);
            }

            static async updateProject(projectHash, projectData) {
                return this.put(`/projects/${projectHash}`, projectData);
            }

            static async deleteProject(projectHash) {
                return this.delete(`/projects/${projectHash}`);
            }

            // Task endpoints
            static async getTasks(projectHash) {
                return this.get(`/tasks/projects/${projectHash}/tasks`);
            }

            static async createTask(taskData) {
                return this.post('/tasks/', taskData);
            }

            // User endpoints
            static async getCurrentUser() {
                return this.get('/users/me');
            }

            // Dashboard endpoints
            static async getDashboard() {
                return this.get('/dashboard/');
            }
        }

        // Основное приложение
        class App {
            static async init() {
                try {
                    console.log('Initializing app...');

                    // Инициализируем аутентификацию
                    await AuthManager.initialize();

                    // Показываем основное приложение
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';

                    // Загружаем данные
                    await this.loadData();

                    // Настраиваем обработчики событий
                    this.setupEventListeners();

                    console.log('App initialized successfully');

                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showError('Ошибка инициализации приложения: ' + error.message);
                }
            }

            static async loadData() {
                try {
                    console.log('Loading data...');

                    // Загружаем дашборд с проектами
                    const dashboardData = await ApiService.getDashboard();
                    const projects = dashboardData.projects || [];

                    this.renderProjects(projects);
                    this.updateStats(projects);

                    console.log('Data loaded successfully');

                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            static renderProjects(projects) {
                const container = document.getElementById('projectsList');

                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; border: 1px solid #ccc; border-radius: 4px;">
                            <p>Проектов пока нет</p>
                            <button onclick="App.showModal('createProjectModal')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Создать первый проект
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = projects.map(project => {
                    const projectData = project.project || project;
                    const stats = projectData.stats || {};

                    return `
                        <div style="padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; cursor: pointer;"
                             onclick="App.openProject('${projectData.hash}')">
                            <div style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">${this.escapeHtml(projectData.title)}</div>
                            <div style="color: #666; margin-bottom: 10px;">${this.escapeHtml(projectData.description || 'Без описания')}</div>
                            <div style="display: flex; gap: 15px; font-size: 14px; color: #888;">
                                <span>Участников: ${stats.members_count || 0}</span>
                                <span>Задач: ${stats.tasks_count || 0}</span>
                                <span>Выполнено: ${stats.tasks_done || 0}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            static updateStats(projects) {
                document.getElementById('projectsCount').textContent = projects.length;

                const totalTasks = projects.reduce((sum, project) => {
                    const stats = (project.project || project).stats || {};
                    return sum + (stats.tasks_count || 0);
                }, 0);

                document.getElementById('tasksCount').textContent = totalTasks;
            }

            static setupEventListeners() {
                // Создание проекта
                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    this.showModal('createProjectModal');
                });
            }

            static showModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            static hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            static async handleCreateProject() {
                const title = document.getElementById('projectTitle').value.trim();
                const description = document.getElementById('projectDescription').value.trim();

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    console.log('Creating project:', { title, description });

                    await ApiService.createProject({
                        title,
                        description,
                        is_private: true,
                        requires_approval: false
                    });

                    // Закрываем модальное окно
                    this.hideModal('createProjectModal');

                    // Очищаем форму
                    document.getElementById('createProjectForm').reset();

                    // Перезагружаем данные
                    await this.loadData();

                    this.showSuccess('Проект создан успешно!');

                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showError('Ошибка создания проекта: ' + error.message);
                }
            }

            static async openProject(projectHash) {
                try {
                    console.log('Opening project:', projectHash);

                    const projectData = await ApiService.getProject(projectHash);
                    const project = projectData.project || projectData;

                    this.showSuccess(`Открыт проект: ${project.title}`);

                    // Здесь можно добавить логику для отображения деталей проекта
                    console.log('Project details:', project);

                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showError('Ошибка открытия проекта: ' + error.message);
                }
            }

            static showError(message) {
                alert('Ошибка: ' + message);
            }

            static showSuccess(message) {
                alert('Успех: ' + message);
            }

            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
