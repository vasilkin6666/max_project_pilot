<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pilot Pro | Управление проектами</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.js" defer></script>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0e8ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                            950: '#1e1b4b',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-down': 'slideDown 0.5s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'bounce-soft': 'bounceSoft 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s infinite',
                        'gradient': 'gradient 3s ease infinite',
                        'blob': 'blob 7s infinite',
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'large': '0 10px 40px -10px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.05)',
                        'xl-soft': '0 20px 50px -12px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 25px rgba(99, 102, 241, 0.15)',
                        'glow-lg': '0 0 50px rgba(99, 102, 241, 0.2)',
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-12px)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' },
                        },
                        gradient: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
                    }
                },
            },
            plugins: [
                function({ addUtilities }) {
                    addUtilities({
                        '.text-shadow': {
                            'text-shadow': '0 2px 4px rgba(0, 0, 0, 0.1)',
                        },
                        '.text-shadow-lg': {
                            'text-shadow': '0 4px 8px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08)',
                        },
                    })
                }
            ],
        }
    </script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --gray-950: #030712;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            color: var(--gray-900);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--gray-100);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-track {
            background: var(--gray-800);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: var(--gray-600);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-intense {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .dark .glass-intense {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Premium card hover effects */
        .premium-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .premium-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .premium-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 25px rgba(99, 102, 241, 0.15);
        }

        .dark .premium-card:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 25px rgba(99, 102, 241, 0.2);
        }

        /* Animated gradient background */
        .gradient-bg {
            background: linear-gradient(-45deg, #6366f1, #8b5cf6, #06b6d4, #10b981);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        /* Premium button styles */
        .btn-premium {
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 8px -2px rgba(0, 0, 0, 0.05);
        }

        .btn-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s ease;
        }

        .btn-premium:hover::before {
            left: 100%;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 4px 10px -4px rgba(0, 0, 0, 0.1);
        }

        .btn-premium:active {
            transform: translateY(0);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Floating elements */
        .float-element {
            animation: float 6s ease-in-out infinite;
        }

        /* Shimmer effect for loading */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        .dark .shimmer {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }

        /* Text gradient */
        .text-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Premium input styles */
        .premium-input {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .premium-input {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .premium-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2), 0 4px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.9);
        }

        .dark .premium-input:focus {
            background: rgba(30, 41, 59, 0.8);
        }

        /* Status indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
        }

        .status-offline {
            background-color: var(--gray-400);
            box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.3);
        }

        .status-busy {
            background-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }

        /* Progress bars */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: var(--gray-200);
            overflow: hidden;
        }

        .dark .progress-bar {
            background-color: var(--gray-700);
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
            animation: pulseSoft 2s infinite;
        }

        /* Avatar styles */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        /* Task priority indicators */
        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .priority-low { background-color: var(--success); }
        .priority-medium { background-color: var(--warning); }
        .priority-high { background-color: var(--danger); }
        .priority-urgent {
            background-color: var(--danger);
            animation: pulseSoft 1.5s infinite;
        }

        /* Kanban column styles */
        .kanban-column {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .dark .kanban-column {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .kanban-column:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        /* Focus states for accessibility */
        .focus-premium:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        /* Selection styles */
        ::selection {
            background-color: rgba(99, 102, 241, 0.2);
        }

        /* Custom checkbox */
        .custom-checkbox {
            position: relative;
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--gray-300);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dark .custom-checkbox {
            border-color: var(--gray-600);
        }

        .custom-checkbox.checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .custom-checkbox.checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 34px;
        }

        .dark .toggle-slider {
            background-color: var(--gray-600);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Pulse animation for notifications */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Blob background element */
        .blob {
            position: absolute;
            opacity: 0.3;
            filter: blur(40px);
            border-radius: 50%;
            z-index: -1;
        }

        .blob-1 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            top: 10%;
            left: 10%;
            animation: blob 15s infinite linear;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #06b6d4 0%, #10b981 100%);
            top: 60%;
            right: 10%;
            animation: blob 18s infinite linear reverse;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .premium-card:hover {
                transform: none;
            }

            .kanban-column:hover {
                transform: none;
            }
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 transition-colors duration-500 min-h-screen">
    <!-- Animated background elements -->
    <div class="fixed inset-0 -z-10 overflow-hidden">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-gray-100/30 dark:from-gray-950/50 dark:to-gray-900/30"></div>
    </div>

    <!-- Splash Screen -->
    <div id="splashScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-primary-500 via-primary-600 to-primary-700 transition-opacity duration-1000">
        <div class="text-center text-white">
            <div class="w-24 h-24 mx-auto mb-8 rounded-2xl glass-intense flex items-center justify-center shadow-xl animate-bounce-soft">
                <i class="fas fa-rocket text-4xl text-white"></i>
            </div>
            <h1 class="text-5xl font-black mb-4 text-shadow-lg">Project Pilot Pro</h1>
            <p class="text-xl opacity-90 mb-8 text-shadow">Премиум управление проектами</p>
            <div class="w-64 h-2 bg-white/30 rounded-full overflow-hidden mx-auto">
                <div id="splashProgressBar" class="h-full bg-white rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="min-h-screen hidden animate-fade-in">
        <!-- Header -->
        <header class="sticky top-0 z-40 glass-intense border-b border-white/20 dark:border-gray-800/50 shadow-soft backdrop-blur-lg">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <!-- Logo and navigation toggle -->
                    <div class="flex items-center space-x-4">
                        <button id="sidebarToggle" class="lg:hidden p-2 rounded-lg bg-white/50 dark:bg-gray-800/50 hover:bg-white/70 dark:hover:bg-gray-700/50 transition-colors focus-premium">
                            <i class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
                        </button>

                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-black bg-gradient-to-r from-primary-600 to-primary-700 bg-clip-text text-transparent">Project Pilot</h1>
                                <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Профессиональное управление</p>
                            </div>
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="flex-1 max-w-2xl mx-4 hidden md:block">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" class="w-full premium-input pl-10 pr-4 py-2.5 rounded-xl focus-premium" placeholder="Поиск проектов, задач, участников...">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <kbd class="px-2 py-1 text-xs font-semibold text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-lg">⌘K</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Right side actions -->
                    <div class="flex items-center space-x-2">
                        <!-- Search Button (Mobile) -->
                        <button class="md:hidden p-2.5 rounded-xl bg-white/50 dark:bg-gray-800/50 hover:bg-white/70 dark:hover:bg-gray-700/50 transition-colors focus-premium">
                            <i class="fas fa-search text-gray-700 dark:text-gray-300"></i>
                        </button>

                        <!-- Create Button -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2 focus-premium">
                                <i class="fas fa-plus"></i>
                                <span class="hidden sm:block">Создать</span>
                                <i class="fas fa-chevron-down text-xs ml-1"></i>
                            </button>

                            <!-- Dropdown Menu -->
                            <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                class="absolute right-0 mt-2 w-56 glass-intense rounded-xl shadow-large border border-white/20 dark:border-gray-700/50 py-2 z-50">
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" onclick="App.showCreateProjectModal()">
                                    <i class="fas fa-folder-plus text-primary-500 mr-3"></i>
                                    <span>Новый проект</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" onclick="App.showCreateTaskModal()">
                                    <i class="fas fa-tasks text-primary-500 mr-3"></i>
                                    <span>Новая задача</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors">
                                    <i class="fas fa-user-plus text-primary-500 mr-3"></i>
                                    <span>Пригласить участника</span>
                                </a>
                                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors">
                                    <i class="fas fa-file-export text-primary-500 mr-3"></i>
                                    <span>Экспорт данных</span>
                                </a>
                            </div>
                        </div>

                        <!-- Notifications -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="p-2.5 rounded-xl bg-white/50 dark:bg-gray-800/50 hover:bg-white/70 dark:hover:bg-gray-700/50 transition-colors relative focus-premium">
                                <i class="fas fa-bell text-gray-700 dark:text-gray-300"></i>
                                <span class="notification-badge">3</span>
                            </button>

                            <!-- Notifications Dropdown -->
                            <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                class="absolute right-0 mt-2 w-80 glass-intense rounded-xl shadow-large border border-white/20 dark:border-gray-700/50 py-2 z-50 max-h-96 overflow-y-auto">
                                <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">Уведомления</h3>
                                </div>
                                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Notification items would go here -->
                                    <div class="p-4 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors cursor-pointer">
                                        <div class="flex space-x-3">
                                            <div class="w-10 h-10 bg-success-100 dark:bg-success-900/30 rounded-full flex items-center justify-center text-success-600 dark:text-success-400">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Задача выполнена</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Мария завершила задачу "Протестировать API"</p>
                                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">2 часа назад</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors cursor-pointer">
                                        <div class="flex space-x-3">
                                            <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-400">
                                                <i class="fas fa-user-plus"></i>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Новый участник</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Алексей присоединился к проекту "Веб-сайт"</p>
                                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">5 часов назад</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors cursor-pointer">
                                        <div class="flex space-x-3">
                                            <div class="w-10 h-10 bg-warning-100 dark:bg-warning-900/30 rounded-full flex items-center justify-center text-warning-600 dark:text-warning-400">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Срок истекает</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Задача "Разработать главную страницу" должна быть завершена завтра</p>
                                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Вчера</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                                    <button class="w-full text-center text-sm text-primary-600 dark:text-primary-400 font-medium py-2 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors">
                                        Показать все уведомления
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Theme Toggle -->
                        <button id="themeToggle" class="p-2.5 rounded-xl bg-white/50 dark:bg-gray-800/50 hover:bg-white/70 dark:hover:bg-gray-700/50 transition-colors focus-premium">
                            <i class="fas fa-moon text-gray-700 dark:text-gray-300"></i>
                        </button>

                        <!-- User Menu -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="flex items-center space-x-2 bg-white/50 dark:bg-gray-800/50 hover:bg-white/70 dark:hover:bg-gray-700/50 rounded-xl px-3 py-2 transition-colors focus-premium">
                                <div class="avatar">
                                    <span>U</span>
                                </div>
                                <div class="hidden md:block text-left">
                                    <div class="font-medium text-gray-900 dark:text-gray-100 text-sm">Пользователь</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Владелец</div>
                                </div>
                                <i class="fas fa-chevron-down text-gray-500 text-xs ml-1"></i>
                            </button>

                            <!-- User Dropdown -->
                            <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                class="absolute right-0 mt-2 w-56 glass-intense rounded-xl shadow-large border border-white/20 dark:border-gray-700/50 py-2 z-50">
                                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                    <div class="font-medium text-gray-900 dark:text-gray-100">Пользователь</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">user@example.com</div>
                                </div>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors">
                                    <i class="fas fa-user mr-3 text-gray-500"></i>
                                    <span>Профиль</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors" onclick="App.showSettings()">
                                    <i class="fas fa-cog mr-3 text-gray-500"></i>
                                    <span>Настройки</span>
                                </a>
                                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                <a href="#" class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-3 text-gray-500"></i>
                                    <span>Выйти</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1">
            <!-- Sidebar -->
            <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-64 bg-white/70 dark:bg-gray-900/70 backdrop-blur-lg border-r border-gray-200 dark:border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="flex flex-col h-full">
                    <!-- Sidebar Header -->
                    <div class="p-4 border-b border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Навигация</h2>
                    </div>

                    <!-- Sidebar Content -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <nav class="space-y-1">
                            <a href="#" class="flex items-center px-4 py-3 text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 rounded-xl font-medium transition-colors">
                                <i class="fas fa-home mr-3"></i>
                                <span>Главная</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors" onclick="App.showMyTasks()">
                                <i class="fas fa-tasks mr-3"></i>
                                <span>Мои задачи</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                                <i class="fas fa-calendar-alt mr-3"></i>
                                <span>Календарь</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                                <i class="fas fa-chart-bar mr-3"></i>
                                <span>Отчеты</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors">
                                <i class="fas fa-users mr-3"></i>
                                <span>Команда</span>
                            </a>
                        </nav>

                        <div class="mt-8">
                            <h3 class="px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Мои проекты</h3>
                            <nav class="mt-2 space-y-1">
                                <a href="#" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors group">
                                    <div class="w-2 h-2 bg-primary-500 rounded-full mr-3"></div>
                                    <span>Веб-сайт компании</span>
                                    <span class="ml-auto text-xs bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 px-2 py-0.5 rounded-full">5</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors group">
                                    <div class="w-2 h-2 bg-success-500 rounded-full mr-3"></div>
                                    <span>Мобильное приложение</span>
                                    <span class="ml-auto text-xs bg-success-100 dark:bg-success-900 text-success-800 dark:text-success-200 px-2 py-0.5 rounded-full">3</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors group">
                                    <div class="w-2 h-2 bg-warning-500 rounded-full mr-3"></div>
                                    <span>Маркетинг кампания</span>
                                    <span class="ml-auto text-xs bg-warning-100 dark:bg-warning-900 text-warning-800 dark:text-warning-200 px-2 py-0.5 rounded-full">7</span>
                                </a>
                                <a href="#" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition-colors group">
                                    <div class="w-2 h-2 bg-danger-500 rounded-full mr-3"></div>
                                    <span>Анализ данных</span>
                                    <span class="ml-auto text-xs bg-danger-100 dark:bg-danger-900 text-danger-800 dark:text-danger-200 px-2 py-0.5 rounded-full">2</span>
                                </a>
                            </nav>
                        </div>

                        <!-- Team Members -->
                        <div class="mt-8">
                            <h3 class="px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Команда</h3>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center px-4 py-2">
                                    <div class="relative">
                                        <div class="avatar bg-gradient-to-br from-purple-500 to-pink-500">A</div>
                                        <div class="status-indicator status-online absolute bottom-0 right-0"></div>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Алексей</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Разработчик</p>
                                    </div>
                                </div>
                                <div class="flex items-center px-4 py-2">
                                    <div class="relative">
                                        <div class="avatar bg-gradient-to-br from-green-500 to-teal-500">M</div>
                                        <div class="status-indicator status-busy absolute bottom-0 right-0"></div>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Мария</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Дизайнер</p>
                                    </div>
                                </div>
                                <div class="flex items-center px-4 py-2">
                                    <div class="relative">
                                        <div class="avatar bg-gradient-to-br from-blue-500 to-cyan-500">I</div>
                                        <div class="status-indicator status-offline absolute bottom-0 right-0"></div>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100">Иван</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Менеджер</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Footer -->
                    <div class="p-4 border-t border-gray-200 dark:border-gray-800">
                        <div class="bg-gradient-to-r from-primary-50 to-primary-100 dark:from-primary-900/20 dark:to-primary-800/20 rounded-xl p-4 text-center">
                            <i class="fas fa-rocket text-primary-500 text-xl mb-2"></i>
                            <p class="text-sm font-medium text-primary-800 dark:text-primary-200">Project Pilot Pro</p>
                            <p class="text-xs text-primary-600 dark:text-primary-400 mt-1">Премиум версия</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 lg:ml-0 transition-all duration-300">
                <!-- Mobile sidebar backdrop -->
                <div id="sidebarBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden" onclick="App.toggleSidebar()"></div>

                <div class="p-6">
                    <!-- Dashboard View -->
                    <div id="dashboardView" class="animate-fade-in">
                        <!-- Welcome Header -->
                        <div class="mb-8">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <h1 class="text-3xl font-black text-gray-900 dark:text-gray-100 mb-2">Добро пожаловать!</h1>
                                    <p class="text-gray-600 dark:text-gray-400">Вот обзор ваших проектов и задач на сегодня.</p>
                                </div>
                                <div class="mt-4 md:mt-0 flex space-x-3">
                                    <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2">
                                        <i class="fas fa-filter"></i>
                                        <span>Фильтр</span>
                                    </button>
                                    <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2">
                                        <i class="fas fa-sort"></i>
                                        <span>Сортировка</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="premium-card p-6 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900/30 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-folder text-primary-600 dark:text-primary-400 text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-black text-gray-900 dark:text-gray-100" id="projectsCount">12</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Проектов</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-primary-500" style="width: 75%"></div>
                                </div>
                            </div>

                            <div class="premium-card p-6 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-success-100 dark:bg-success-900/30 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-tasks text-success-600 dark:text-success-400 text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-black text-gray-900 dark:text-gray-100" id="tasksCount">47</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Задач</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-success-500" style="width: 60%"></div>
                                </div>
                            </div>

                            <div class="premium-card p-6 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-warning-100 dark:bg-warning-900/30 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-clock text-warning-600 dark:text-warning-400 text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-black text-gray-900 dark:text-gray-100" id="recentTasksCount">8</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Недавние</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-warning-500" style="width: 40%"></div>
                                </div>
                            </div>

                            <div class="premium-card p-6 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-danger-100 dark:bg-danger-900/30 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-check-circle text-danger-600 dark:text-danger-400 text-xl"></i>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-black text-gray-900 dark:text-gray-100" id="completedTasksCount">23</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Выполнено</div>
                                    </div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-danger-500" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Tasks and Projects -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Recent Tasks -->
                            <div class="premium-card rounded-2xl overflow-hidden">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Недавние задачи</h2>
                                        <a href="#" class="text-sm text-primary-600 dark:text-primary-400 font-medium hover:underline">Все задачи</a>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="task-list space-y-4" id="recentTasksList">
                                        <!-- Recent tasks will be loaded here -->
                                        <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                                            <div class="custom-checkbox checked mr-4"></div>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 dark:text-gray-100">Разработать главную страницу</div>
                                                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                    <span><i class="fas fa-project-diagram mr-1"></i> Веб-сайт компании</span>
                                                    <span class="flex items-center"><span class="priority-indicator priority-high"></span> Высокий</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">15 мая</div>
                                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Алексей</div>
                                            </div>
                                        </div>

                                        <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                                            <div class="custom-checkbox mr-4"></div>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 dark:text-gray-100">Протестировать API</div>
                                                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                    <span><i class="fas fa-project-diagram mr-1"></i> Мобильное приложение</span>
                                                    <span class="flex items-center"><span class="priority-indicator priority-medium"></span> Средний</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">18 мая</div>
                                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Мария</div>
                                            </div>
                                        </div>

                                        <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                                            <div class="custom-checkbox mr-4"></div>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 dark:text-gray-100">Подготовить документацию</div>
                                                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                    <span><i class="fas fa-project-diagram mr-1"></i> Анализ данных</span>
                                                    <span class="flex items-center"><span class="priority-indicator priority-low"></span> Низкий</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">20 мая</div>
                                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Иван</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- My Projects -->
                            <div class="premium-card rounded-2xl overflow-hidden">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Мои проекты</h2>
                                        <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-xl font-medium flex items-center space-x-2" onclick="App.showCreateProjectModal()">
                                            <i class="fas fa-plus"></i>
                                            <span>Новый проект</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="project-grid space-y-4" id="projectsList">
                                        <!-- Projects will be loaded here -->
                                        <div class="p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-700 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm transition-all cursor-pointer" onclick="App.openProject('project1')">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-globe text-primary-600 dark:text-primary-400"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="font-bold text-gray-900 dark:text-gray-100">Веб-сайт компании</h3>
                                                        <div class="flex items-center mt-1 space-x-2">
                                                            <span class="px-2 py-1 bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 text-xs font-medium rounded-full">Публичный</span>
                                                            <span class="text-xs text-gray-500 dark:text-gray-400">65% завершено</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Разработка корпоративного сайта с современным дизайном и адаптивной версткой</p>
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                    <span><i class="fas fa-users mr-1"></i> 5 участников</span>
                                                    <span><i class="fas fa-tasks mr-1"></i> 12 задач</span>
                                                </div>
                                                <div class="flex -space-x-2">
                                                    <div class="avatar bg-gradient-to-br from-purple-500 to-pink-500 w-8 h-8 text-xs">A</div>
                                                    <div class="avatar bg-gradient-to-br from-green-500 to-teal-500 w-8 h-8 text-xs">M</div>
                                                    <div class="avatar bg-gradient-to-br from-blue-500 to-cyan-500 w-8 h-8 text-xs">I</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-700 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm transition-all cursor-pointer" onclick="App.openProject('project2')">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-success-100 dark:bg-success-900/30 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-mobile-alt text-success-600 dark:text-success-400"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="font-bold text-gray-900 dark:text-gray-100">Мобильное приложение</h3>
                                                        <div class="flex items-center mt-1 space-x-2">
                                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs font-medium rounded-full">Приватный</span>
                                                            <span class="text-xs text-gray-500 dark:text-gray-400">40% завершено</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Разработка кроссплатформенного мобильного приложения для iOS и Android</p>
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                    <span><i class="fas fa-users mr-1"></i> 3 участника</span>
                                                    <span><i class="fas fa-tasks mr-1"></i> 8 задач</span>
                                                </div>
                                                <div class="flex -space-x-2">
                                                    <div class="avatar bg-gradient-to-br from-purple-500 to-pink-500 w-8 h-8 text-xs">A</div>
                                                    <div class="avatar bg-gradient-to-br from-green-500 to-teal-500 w-8 h-8 text-xs">M</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project View (hidden by default) -->
                    <div id="projectView" class="hidden animate-fade-in">
                        <!-- Project details will be loaded here -->
                    </div>

                    <!-- Task View (hidden by default) -->
                    <div id="taskView" class="hidden animate-fade-in">
                        <!-- Task details will be loaded here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Bottom Navigation (Mobile) -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 glass-intense border-t border-white/20 dark:border-gray-800/50 flex justify-around py-3 z-40 backdrop-blur-lg">
            <a href="#" class="flex flex-col items-center text-primary-600 dark:text-primary-400">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Главная</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 dark:text-gray-400">
                <i class="fas fa-tasks text-xl"></i>
                <span class="text-xs mt-1">Задачи</span>
            </a>
            <button class="flex flex-col items-center text-gray-500 dark:text-gray-400" onclick="App.showCreateProjectModal()">
                <div class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center text-white -mt-6 shadow-lg">
                    <i class="fas fa-plus text-xl"></i>
                </div>
                <span class="text-xs mt-1">Создать</span>
            </button>
            <a href="#" class="flex flex-col items-center text-gray-500 dark:text-gray-400">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Календарь</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 dark:text-gray-400">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Профиль</span>
            </a>
        </nav>
    </div>

    <!-- Modals -->
    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity duration-300">
        <div class="modal premium-card rounded-2xl w-full max-w-md transform transition-transform duration-300 scale-95 opacity-0">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Создать проект</h3>
                    <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors focus-premium" onclick="App.hideModal('createProjectModal')">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="createProjectForm">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="projectTitle">Название проекта</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-heading text-gray-400"></i>
                            </div>
                            <input type="text" id="projectTitle" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium" placeholder="Введите название проекта" required>
                        </div>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="projectDescription">Описание</label>
                        <div class="relative">
                            <div class="absolute top-3 left-3 pointer-events-none">
                                <i class="fas fa-align-left text-gray-400"></i>
                            </div>
                            <textarea id="projectDescription" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium" rows="3" placeholder="Опишите ваш проект"></textarea>
                        </div>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Настройки проекта</label>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-2 px-3 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                                <div class="flex items-center">
                                    <i class="fas fa-lock text-gray-500 mr-3"></i>
                                    <span>Приватный проект</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="projectIsPrivate" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between py-2 px-3 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                                <div class="flex items-center">
                                    <i class="fas fa-user-check text-gray-500 mr-3"></i>
                                    <span>Требуется одобрение</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="projectRequiresApproval">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-5 py-2.5 rounded-xl font-medium transition-colors" onclick="App.hideModal('createProjectModal')">
                    Отмена
                </button>
                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-5 py-2.5 rounded-xl font-medium" onclick="App.handleCreateProject()">
                    Создать проект
                </button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity duration-300">
        <div class="modal premium-card rounded-2xl w-full max-w-lg transform transition-transform duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Создать задачу</h3>
                    <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors focus-premium" onclick="App.hideModal('createTaskModal')">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="createTaskForm">
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="taskTitle">Название задачи</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-heading text-gray-400"></i>
                            </div>
                            <input type="text" id="taskTitle" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium" placeholder="Введите название задачи" required>
                        </div>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="taskDescription">Описание</label>
                        <div class="relative">
                            <div class="absolute top-3 left-3 pointer-events-none">
                                <i class="fas fa-align-left text-gray-400"></i>
                            </div>
                            <textarea id="taskDescription" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium" rows="3" placeholder="Опишите задачу"></textarea>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="taskPriority">Приоритет</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-flag text-gray-400"></i>
                                </div>
                                <select id="taskPriority" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium appearance-none">
                                    <option value="low">Низкий</option>
                                    <option value="medium" selected>Средний</option>
                                    <option value="high">Высокий</option>
                                    <option value="urgent">Срочный</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="taskDueDate">Срок выполнения</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-calendar-alt text-gray-400"></i>
                                </div>
                                <input type="date" id="taskDueDate" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium">
                            </div>
                        </div>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="taskAssignedTo">Исполнитель</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <select id="taskAssignedTo" class="premium-input w-full pl-10 pr-4 py-3 rounded-xl focus-premium appearance-none">
                                <option value="">Не назначена</option>
                                <option value="user1">Алексей</option>
                                <option value="user2">Мария</option>
                                <option value="user3">Иван</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-5 py-2.5 rounded-xl font-medium transition-colors" onclick="App.hideModal('createTaskModal')">
                    Отмена
                </button>
                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-5 py-2.5 rounded-xl font-medium" onclick="App.handleCreateTask()">
                    Создать задачу
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity duration-300">
        <div class="modal premium-card rounded-2xl w-full max-w-md transform transition-transform duration-300 scale-95 opacity-0 max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Уведомления</h3>
                    <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors focus-premium" onclick="App.hideModal('notificationsModal')">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="notificationsList">
                    <!-- Notifications will be loaded here -->
                    <div class="flex items-start space-x-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                        <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-400">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 dark:text-gray-100">Новый участник</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Алексей присоединился к проекту "Веб-сайт компании"</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">2 часа назад</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                        <div class="w-10 h-10 bg-success-100 dark:bg-success-900/30 rounded-full flex items-center justify-center text-success-600 dark:text-success-400">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 dark:text-gray-100">Задача выполнена</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Мария завершила задачу "Протестировать API"</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">5 часов назад</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer">
                        <div class="w-10 h-10 bg-warning-100 dark:bg-warning-900/30 rounded-full flex items-center justify-center text-warning-600 dark:text-warning-400">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 dark:text-gray-100">Срок истекает</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Задача "Разработать главную страницу" должна быть завершена завтра</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">Вчера</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white w-full py-2.5 rounded-xl font-medium" onclick="App.markAllNotificationsRead()">
                    Отметить все как прочитанные
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3 max-w-sm"></div>

    <script>
        // Конфигурация
        const CONFIG = {
            API_BASE_URL: 'https://powerfully-exotic-chamois.cloudpub.ru/api'
        };

        // Глобальные переменные
        let currentProject = null;
        let currentTask = null;
        let currentUser = null;
        let currentMemberToUpdate = null;
        let currentMemberToRemove = null;
        let userSettings = {};

        // Константы ролей проекта
        const ProjectRole = {
            OWNER: 'owner',
            ADMIN: 'admin',
            MEMBER: 'member',
            GUEST: 'guest'
        };

        // Утилиты для UI
        class UIUtils {
            // Показать уведомление
            static showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();

                const typeConfig = {
                    success: { bg: 'bg-success-500', icon: 'fa-check-circle' },
                    error: { bg: 'bg-danger-500', icon: 'fa-exclamation-circle' },
                    warning: { bg: 'bg-warning-500', icon: 'fa-exclamation-triangle' },
                    info: { bg: 'bg-primary-500', icon: 'fa-info-circle' }
                };

                const config = typeConfig[type] || typeConfig.info;

                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `p-4 rounded-xl text-white shadow-lg transform transition-all duration-300 translate-x-full opacity-0 ${config.bg}`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${config.icon} mr-3"></i>
                        <div class="flex-1">${message}</div>
                        <button class="ml-4" onclick="document.getElementById('${toastId}').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                toastContainer.appendChild(toast);

                // Анимация появления
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 10);

                // Автоматическое скрытие
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 5000);
            }

            // Показать модальное окно
            static showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        const modalContent = modal.querySelector('.modal');
                        if (modalContent) {
                            modalContent.classList.remove('scale-95', 'opacity-0');
                            modalContent.classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            }

            // Скрыть модальное окно
            static hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    const modalContent = modal.querySelector('.modal');
                    if (modalContent) {
                        modalContent.classList.remove('scale-100', 'opacity-100');
                        modalContent.classList.add('scale-95', 'opacity-0');
                    }

                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            }

            // Переключение сайдбара на мобильных устройствах
            static toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('sidebarBackdrop');

                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    backdrop.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                }
            }

            // Переключение темы
            static toggleTheme() {
                const themeToggle = document.getElementById('themeToggle');
                const isDark = document.documentElement.classList.contains('dark');

                if (isDark) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }

            // Инициализация темы из localStorage
            static initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                const themeToggle = document.getElementById('themeToggle');

                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                }
            }
        }

        // Менеджер аутентификации
        class AuthManager {
            static async initialize() {
                try {
                    console.log('Initializing authentication...');
                    // Проверяем MAX окружение
                    if (typeof WebApp !== 'undefined' && WebApp.initDataUnsafe?.user) {
                        return await this.authenticateWithMax();
                    } else {
                        // Для разработки - тестовый пользователь
                        return await this.authenticateWithTestUser();
                    }
                } catch (error) {
                    console.error('Authentication failed:', error);
                    throw error;
                }
            }

            static async authenticateWithMax() {
                const userData = WebApp.initDataUnsafe.user;
                const maxId = userData.id.toString();
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Пользователь MAX';
                console.log('MAX authentication with:', { maxId, fullName });
                const tokenData = await ApiService.getAuthToken(maxId, fullName, userData.username || '');
                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('MAX authentication successful');
                    return tokenData.user;
                }
                throw new Error('MAX authentication failed');
            }

            static async authenticateWithTestUser() {
                const testId = 'dev_user_' + Math.random().toString(36).substr(2, 9);
                const fullName = 'Тестовый пользователь';
                console.log('Test authentication with:', { testId, fullName });
                const tokenData = await ApiService.getAuthToken(testId, fullName, '');
                if (tokenData?.access_token) {
                    localStorage.setItem('access_token', tokenData.access_token);
                    console.log('Test authentication successful');
                    return tokenData.user;
                }
                throw new Error('Test authentication failed');
            }

            static getToken() {
                return localStorage.getItem('access_token');
            }

            static isAuthenticated() {
                return !!this.getToken();
            }
        }

        // API сервис
        class ApiService {
            static async request(endpoint, options = {}) {
                const token = AuthManager.getToken();
                const url = `${CONFIG.API_BASE_URL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                console.log(`API Request: ${options.method || 'GET'} ${url}`);
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    const data = await response.json();
                    console.log(`API Response:`, data);
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            static async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            static async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            static async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }

            static async patch(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
            }

            static async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }

            // Auth endpoints
            static async getAuthToken(maxId, fullName, username) {
                return this.post('/auth/token', {
                    max_id: maxId,
                    full_name: fullName,
                    username: username
                });
            }

            // Project endpoints
            static async getProjects() {
                return this.get('/projects/');
            }

            static async createProject(projectData) {
                return this.post('/projects/', projectData);
            }

            static async getProject(projectHash) {
                return this.get(`/projects/${projectHash}`);
            }

            static async updateProject(projectHash, projectData) {
                return this.put(`/projects/${projectHash}`, projectData);
            }

            static async deleteProject(projectHash) {
                return this.delete(`/projects/${projectHash}`);
            }

            static async getProjectMembers(projectHash) {
                return this.get(`/projects/${projectHash}/members`);
            }

            static async updateMemberRole(projectHash, userId, role) {
                return this.put(`/projects/${projectHash}/members/${userId}`, { role });
            }

            static async removeProjectMember(projectHash, userId) {
                return this.delete(`/projects/${projectHash}/members/${userId}`);
            }

            static async approveJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/approve`);
            }

            static async rejectJoinRequest(projectHash, requestId) {
                return this.post(`/projects/${projectHash}/join-requests/${requestId}/reject`);
            }

            static async getProjectJoinRequests(projectHash) {
                return this.get(`/projects/${projectHash}/join-requests`);
            }

            static async joinProject(projectHash) {
                return this.post(`/projects/${projectHash}/join`);
            }

            static async regenerateInvite(projectHash) {
                return this.post(`/projects/${projectHash}/regenerate-invite`);
            }

            static async getProjectSummary(projectHash) {
                return this.get(`/projects/${projectHash}/summary`);
            }

            // Поиск публичных проектов
            static async searchPublicProjects(query = '') {
                const params = query ? `?query=${encodeURIComponent(query)}` : '';
                return this.get(`/projects/search/public${params}`);
            }

            // Получить проект по точному хэшу
            static async getProjectByHashExact(projectHash) {
                return this.get(`/projects/by-hash/${projectHash}`);
            }

            // Task endpoints
            static async getTasks(projectHash) {
                return this.get(`/tasks/projects/${projectHash}/tasks`);
            }

            static async getUserTasks(filters = {}) {
                const params = new URLSearchParams();
                if (filters.status) params.append('status', filters.status);
                if (filters.project_hash) params.append('project_hash', filters.project_hash);
                const query = params.toString();
                return this.get(`/tasks/${query ? `?${query}` : ''}`);
            }

            static async createTask(taskData) {
                // Преобразуем assigned_to_ids в assigned_to_id если нужно
                if (taskData.assigned_to_ids && taskData.assigned_to_ids.length > 0) {
                    taskData.assigned_to_id = taskData.assigned_to_ids[0];
                    delete taskData.assigned_to_ids;
                }
                return this.post('/tasks/', taskData);
            }

            static async getTask(taskId) {
                return this.get(`/tasks/${taskId}`);
            }

            static async updateTask(taskId, taskData) {
                // Преобразуем assigned_to_ids в assigned_to_id если нужно
                if (taskData.assigned_to_ids && taskData.assigned_to_ids.length > 0) {
                    taskData.assigned_to_id = taskData.assigned_to_ids[0];
                    delete taskData.assigned_to_ids;
                } else if (taskData.assigned_to_ids && taskData.assigned_to_ids.length === 0) {
                    taskData.assigned_to_id = null;
                    delete taskData.assigned_to_ids;
                }
                return this.put(`/tasks/${taskId}`, taskData);
            }

            static async deleteTask(taskId) {
                return this.delete(`/tasks/${taskId}`);
            }

            static async updateTaskStatus(taskId, status) {
                return this.put(`/tasks/${taskId}/status?status=${status}`);
            }

            // Управление зависимостями задач
            static async getTaskDependencies(taskId) {
                return this.get(`/tasks/${taskId}/dependencies`);
            }

            static async addTaskDependency(taskId, dependsOnId) {
                return this.post(`/tasks/${taskId}/dependencies?depends_on_id=${dependsOnId}`);
            }

            static async removeTaskDependency(taskId, dependsOnId) {
                return this.delete(`/tasks/${taskId}/dependencies?depends_on_id=${dependsOnId}`);
            }

            static async getTaskComments(taskId) {
                return this.get(`/tasks/${taskId}/comments`);
            }

            static async createTaskComment(taskId, content) {
                return this.post(`/tasks/${taskId}/comments?content=${encodeURIComponent(content)}`);
            }

            // User endpoints
            static async getCurrentUser() {
                return this.get('/users/me');
            }

            // ИСПРАВЛЕНО: Правильное обновление пользователя
            static async updateCurrentUser(userData) {
                const params = new URLSearchParams();
                if (userData.full_name) params.append('full_name', userData.full_name);
                if (userData.username) params.append('username', userData.username);
                return this.request(`/users/me?${params}`, { method: 'PUT' });
            }

            static async getUserPreferences() {
                return this.get('/users/me/preferences');
            }

            static async updateUserPreferences(preferences) {
                return this.put('/users/me/preferences', preferences);
            }

            static async patchUserPreferences(preferences) {
                return this.patch('/users/me/preferences', preferences);
            }

            static async resetUserPreferences() {
                return this.put('/users/me/preferences/reset');
            }

            static async getUser(userId) {
                return this.get(`/users/${userId}`);
            }

            // Получение проектов пользователя
            static async getUserProjects(userId) {
                return this.get(`/users/${userId}/projects`);
            }

            static async deleteJoinRequest(projectHash, requestId) {
                return this.delete(`/projects/${projectHash}/join-requests/${requestId}`);
            }

            // Notifications endpoints
            static async getNotifications() {
                return this.get('/notifications/');
            }

            static async markAllNotificationsRead() {
                return this.put('/notifications/mark_all_read');
            }

            // Dashboard endpoints
            static async getDashboard() {
                return this.get('/dashboard/');
            }

            // Health endpoints
            static async healthCheck() {
                return this.get('/health');
            }

            static async apiHealthCheck() {
                return this.get('/api/health');
            }
        }

        // Основное приложение
        class App {
            static async init() {
                try {
                    console.log('Initializing app...');

                    // Показываем заставку
                    this.showSplashScreen();

                    // Инициализируем тему
                    UIUtils.initTheme();

                    // Инициализируем аутентификацию
                    currentUser = await AuthManager.initialize();

                    // Загружаем данные
                    await this.loadData();

                    // Настраиваем обработчики событий
                    this.setupEventListeners();

                    console.log('App initialized successfully');
                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showError('Ошибка инициализации приложения: ' + error.message);
                }
            }

            static showSplashScreen() {
                const splashScreen = document.getElementById('splashScreen');
                const progressBar = document.getElementById('splashProgressBar');
                const appContainer = document.getElementById('appContainer');

                // Анимируем прогресс-бар
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);

                        // Скрываем заставку и показываем приложение
                        setTimeout(() => {
                            splashScreen.style.opacity = '0';
                            setTimeout(() => {
                                splashScreen.style.display = 'none';
                                appContainer.classList.remove('hidden');
                            }, 1000);
                        }, 500);
                    }
                    progressBar.style.width = `${progress}%`;
                }, 200);
            }

            static async loadData() {
                try {
                    console.log('Loading data...');
                    // Загружаем дашборд с проектами
                    const dashboardData = await ApiService.getDashboard();
                    const projects = dashboardData.projects || [];
                    const settings = dashboardData.settings || {};
                    const recentTasks = dashboardData.recent_tasks || [];

                    // Сохраняем настройки
                    userSettings = settings;
                    this.applyUserSettings(settings);

                    this.renderProjects(projects);
                    this.updateStats(projects, recentTasks);
                    this.renderRecentTasks(recentTasks);

                    console.log('Data loaded successfully');
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Ошибка загрузки данных: ' + error.message);
                }
            }

            // Применение настроек пользователя
            static applyUserSettings(settings) {
                if (settings.theme) {
                    if (settings.theme === 'dark' || (settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                    }
                }
            }

            static renderProjects(projects) {
                const container = document.getElementById('projectsList');
                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                <i class="fas fa-folder-open text-3xl text-gray-400"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">Проектов пока нет</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">Создайте свой первый проект, чтобы начать работу</p>
                            <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-xl font-medium" onclick="App.showCreateProjectModal()">
                                <i class="fas fa-plus mr-2"></i> Создать проект
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = projects.map(project => {
                    // ИСПРАВЛЕНО: Правильное получение данных проекта и статистики
                    const projectData = project.project || project;
                    // Получаем статистику из разных возможных источников
                    const stats = project.stats || projectData.stats || {};
                    // ИСПРАВЛЕНО: Правильные названия полей статистики
                    const membersCount = stats.members_count || stats.membersCount || 0;
                    const tasksCount = stats.tasks_count || stats.tasksCount || 0;
                    const doneTasks = stats.tasks_done || stats.done_tasks || stats.doneTasks || 0;
                    const inProgressTasks = stats.tasks_in_progress || stats.in_progress_tasks || stats.inProgressTasks || 0;
                    const todoTasks = stats.tasks_todo || stats.todo_tasks || stats.todoTasks || 0;

                    const progress = tasksCount > 0 ? (doneTasks / tasksCount) * 100 : 0;

                    let badgeClass = 'bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200';
                    let badgeText = 'Публичный';

                    if (projectData.is_private) {
                        badgeClass = projectData.requires_approval ?
                            'bg-warning-100 dark:bg-warning-900 text-warning-800 dark:text-warning-200' :
                            'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
                        badgeText = projectData.requires_approval ? 'Одобрение' : 'Приватный';
                    }

                    return `
                        <div class="p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-700 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm transition-all cursor-pointer premium-card" onclick="App.openProject('${projectData.hash}')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-folder text-primary-600 dark:text-primary-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-gray-100">${this.escapeHtml(projectData.title)}</h3>
                                        <div class="flex items-center mt-1 space-x-2">
                                            <span class="px-2 py-1 ${badgeClass} text-xs font-medium rounded-full">${badgeText}</span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">${Math.round(progress)}% завершено</span>
                                        </div>
                                    </div>
                                </div>
                                <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg transition-colors">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">${this.escapeHtml(projectData.description || 'Без описания')}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span><i class="fas fa-users mr-1"></i> ${membersCount} участников</span>
                                    <span><i class="fas fa-tasks mr-1"></i> ${tasksCount} задач</span>
                                </div>
                                <div class="flex -space-x-2">
                                    <!-- Аватары участников будут добавлены здесь -->
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Отображение недавних задач
            static renderRecentTasks(recentTasks) {
                const container = document.getElementById('recentTasksList');
                if (!recentTasks || recentTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                <i class="fas fa-tasks text-xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Нет недавних задач</h3>
                            <p class="text-gray-600 dark:text-gray-400">Задачи, над которыми вы работали, появятся здесь</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recentTasks.map(task => `
                    <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer" onclick="App.openTask(${task.id})">
                        <div class="custom-checkbox ${task.status === 'done' ? 'checked' : ''} mr-4"></div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 dark:text-gray-100">${this.escapeHtml(task.title)}</div>
                            <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                <span><i class="fas fa-project-diagram mr-1"></i> ${task.project_title || 'Проект'}</span>
                                <span class="flex items-center"><span class="priority-indicator priority-${task.priority}"></span> ${this.getPriorityText(task.priority)}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'Без срока'}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${task.assigned_user ? this.escapeHtml(task.assigned_user.full_name) : 'Не назначена'}</div>
                        </div>
                    </div>
                `).join('');
            }

            static updateStats(projects, recentTasks) {
                // ИСПРАВЛЕНО: Правильный подсчет статистики
                document.getElementById('projectsCount').textContent = projects.length;
                const totalTasks = projects.reduce((sum, project) => {
                    const projectData = project.project || project;
                    const stats = project.stats || projectData.stats || {};
                    return sum + (stats.tasks_count || stats.tasksCount || 0);
                }, 0);
                document.getElementById('tasksCount').textContent = totalTasks;
                document.getElementById('recentTasksCount').textContent = recentTasks ? recentTasks.length : 0;

                const completed = projects.reduce((sum, project) => {
                    const projectData = project.project || project;
                    const stats = project.stats || projectData.stats || {};
                    return sum + (stats.tasks_done || stats.done_tasks || stats.doneTasks || 0);
                }, 0);
                document.getElementById('completedTasksCount').textContent = completed;
            }

            static setupEventListeners() {
                // Переключение темы
                document.getElementById('themeToggle').addEventListener('click', () => {
                    UIUtils.toggleTheme();
                });

                // Переключение сайдбара на мобильных
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    UIUtils.toggleSidebar();
                });

                // Создание проекта
                document.addEventListener('click', (e) => {
                    if (e.target.closest('#createProjectBtn')) {
                        this.showCreateProjectModal();
                    }
                });

                // Уведомления
                document.addEventListener('click', (e) => {
                    if (e.target.closest('#notificationsBtn')) {
                        this.showNotifications();
                    }
                });
            }

            static showView(viewId) {
                // Скрываем все вью
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('projectView').classList.add('hidden');
                document.getElementById('taskView').classList.add('hidden');

                // Показываем нужную вью
                document.getElementById(viewId).classList.remove('hidden');
            }

            static showDashboard() {
                this.showView('dashboardView');
                this.loadData();
            }

            static async openProject(projectHash) {
                try {
                    console.log('Opening project:', projectHash);
                    const projectData = await ApiService.getProject(projectHash);
                    // ИСПРАВЛЕНО: Правильное получение данных проекта
                    currentProject = projectData.project || projectData;
                    currentProject.members = projectData.members || [];

                    // Получаем сводку проекта для статистики
                    const projectSummary = await ApiService.getProjectSummary(projectHash);
                    console.log('Project data:', currentProject);
                    console.log('Project summary:', projectSummary);

                    // Рендерим представление проекта
                    this.renderProjectView(currentProject, projectSummary);

                    this.showView('projectView');
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showError('Ошибка открытия проекта: ' + error.message);
                }
            }

            static renderProjectView(project, summary) {
                const projectView = document.getElementById('projectView');

                // Формируем HTML для представления проекта
                projectView.innerHTML = `
                    <div class="mb-8">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900 dark:text-gray-100 mb-2">${this.escapeHtml(project.title)}</h1>
                                <div class="flex items-center mt-2 space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span><i class="fas fa-users mr-1"></i> ${summary.members_count || 0} участников</span>
                                    <span><i class="fas fa-tasks mr-1"></i> ${summary.tasks_count || 0} задач</span>
                                    <span><i class="fas fa-check-circle mr-1"></i> ${summary.tasks_done || 0} выполнено</span>
                                    <span><i class="fas fa-sync-alt mr-1"></i> ${summary.tasks_in_progress || 0} в работе</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-4 md:mt-0">
                                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.showCreateTaskModal()">
                                    <i class="fas fa-plus"></i>
                                    <span>Новая задача</span>
                                </button>
                                <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.showDashboard()">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>Назад</span>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400">${this.escapeHtml(project.description || 'Без описания')}</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="premium-card rounded-2xl overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Задачи проекта</h2>
                                        <div class="flex space-x-2">
                                            <select class="premium-input text-sm rounded-xl focus-premium">
                                                <option>Все статусы</option>
                                                <option>К выполнению</option>
                                                <option>В работе</option>
                                                <option>Выполнено</option>
                                            </select>
                                            <select class="premium-input text-sm rounded-xl focus-premium">
                                                <option>Все приоритеты</option>
                                                <option>Низкий</option>
                                                <option>Средний</option>
                                                <option>Высокий</option>
                                                <option>Срочный</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="task-list space-y-4" id="projectTasksList">
                                        <!-- Задачи проекта будут загружены здесь -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="premium-card rounded-2xl overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Участники</h2>
                                </div>
                                <div class="p-6">
                                    <div id="projectMembersList">
                                        <!-- Участники проекта будут загружены здесь -->
                                    </div>
                                </div>
                            </div>

                            <div class="premium-card rounded-2xl overflow-hidden">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Статистика</h2>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex justify-between mb-1">
                                                <span class="text-sm font-medium">Общий прогресс</span>
                                                <span class="text-sm font-medium">${summary.tasks_count > 0 ? Math.round((summary.tasks_done / summary.tasks_count) * 100) : 0}%</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill bg-primary-500" style="width: ${summary.tasks_count > 0 ? (summary.tasks_done / summary.tasks_count) * 100 : 0}%"></div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                                                <div class="text-2xl font-black text-primary-500">${summary.tasks_todo || 0}</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">К выполнению</div>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                                                <div class="text-2xl font-black text-warning-500">${summary.tasks_in_progress || 0}</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">В работе</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Загружаем задачи и участников проекта
                this.loadProjectTasks(project.hash);
                this.loadProjectMembers(project.hash);
            }

            static async loadProjectTasks(projectHash) {
                try {
                    const response = await ApiService.getTasks(projectHash);
                    const tasks = response.tasks || [];
                    const container = document.getElementById('projectTasksList');

                    if (!tasks || tasks.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                    <i class="fas fa-tasks text-xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Задач пока нет</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Создайте первую задачу для этого проекта</p>
                                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-xl font-medium" onclick="App.showCreateTaskModal()">
                                    <i class="fas fa-plus mr-2"></i> Создать задачу
                                </button>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = tasks.map(task => `
                        <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors cursor-pointer" onclick="App.openTask(${task.id})">
                            <div class="custom-checkbox ${task.status === 'done' ? 'checked' : ''} mr-4"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-gray-100">${this.escapeHtml(task.title)}</div>
                                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center"><span class="priority-indicator priority-${task.priority}"></span> ${this.getPriorityText(task.priority)}</span>
                                    <span><i class="fas fa-calendar-alt mr-1"></i> ${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'Без срока'}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">${task.assigned_user ? this.escapeHtml(task.assigned_user.full_name) : 'Не назначена'}</div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading project tasks:', error);
                    document.getElementById('projectTasksList').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Ошибка загрузки задач</p>';
                }
            }

            static async loadProjectMembers(projectHash) {
                try {
                    const response = await ApiService.getProjectMembers(projectHash);
                    const members = response.members || [];
                    const container = document.getElementById('projectMembersList');

                    if (!members || members.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Участников нет</p>';
                        return;
                    }

                    container.innerHTML = members.map(member => {
                        // ИСПРАВЛЕНО: Правильное получение данных участника
                        const memberData = member.user || member;
                        const displayName = (memberData.full_name && memberData.full_name.trim() !== '')
                            ? memberData.full_name
                            : (member.full_name && member.full_name.trim() !== '')
                            ? member.full_name
                            : `Участник #${member.user_id || memberData.id}`;

                        return `
                            <div class="flex items-center space-x-3 py-3 border-b border-gray-200 dark:border-gray-700 last:border-0">
                                <div class="avatar bg-gradient-to-br from-primary-500 to-primary-600">
                                    ${displayName.charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900 dark:text-gray-100">${this.escapeHtml(displayName)}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">${this.getRoleText(member.role)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error loading project members:', error);
                    document.getElementById('projectMembersList').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Ошибка загрузки участников</p>';
                }
            }

            static async openTask(taskId) {
                try {
                    console.log('Opening task:', taskId);
                    const response = await ApiService.getTask(taskId);
                    currentTask = response.task || response;
                    console.log('Current task set to:', currentTask);

                    if (!currentTask) {
                        this.showError('Задача не найдена');
                        return;
                    }

                    // Рендерим представление задачи
                    this.renderTaskView(currentTask);

                    this.showView('taskView');
                } catch (error) {
                    console.error('Error opening task:', error);
                    this.showError('Ошибка открытия задачи: ' + error.message);
                }
            }

            static renderTaskView(task) {
                const taskView = document.getElementById('taskView');

                taskView.innerHTML = `
                    <div class="mb-8">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900 dark:text-gray-100 mb-2">${this.escapeHtml(task.title)}</h1>
                                <div class="flex items-center mt-2 space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span><i class="fas fa-calendar-alt mr-1"></i> Создана: ${new Date(task.created_at).toLocaleDateString()}</span>
                                    <span><i class="fas fa-user mr-1"></i> ${task.assigned_user ? this.escapeHtml(task.assigned_user.full_name) : 'Не назначена'}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-4 md:mt-0">
                                <button class="btn-premium bg-success-500 hover:bg-success-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.showCreateSubtaskModal()">
                                    <i class="fas fa-plus"></i>
                                    <span>Подзадача</span>
                                </button>
                                <button class="btn-premium bg-warning-500 hover:bg-warning-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.showEditTaskModal()">
                                    <i class="fas fa-edit"></i>
                                    <span>Редактировать</span>
                                </button>
                                <button class="btn-premium bg-danger-500 hover:bg-danger-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.showDeleteTaskModal()">
                                    <i class="fas fa-trash"></i>
                                    <span>Удалить</span>
                                </button>
                                <button class="btn-premium bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2" onclick="App.backToProject()">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>Назад</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="premium-card rounded-2xl overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Описание</h2>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-700 dark:text-gray-300">${this.escapeHtml(task.description || 'Без описания')}</p>
                                </div>
                            </div>

                            <div class="premium-card rounded-2xl overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Подзадачи</h2>
                                </div>
                                <div class="p-6">
                                    <div id="subtasksList">
                                        <!-- Подзадачи будут загружены здесь -->
                                    </div>
                                </div>
                            </div>

                            <div class="premium-card rounded-2xl overflow-hidden">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Комментарии</h2>
                                </div>
                                <div class="p-6">
                                    <div id="taskCommentsList" class="mb-4">
                                        <!-- Комментарии будут загружены здесь -->
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="text" id="newCommentText" placeholder="Введите комментарий..." class="premium-input flex-1 rounded-xl focus-premium">
                                        <button onclick="App.addComment()" class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2.5 rounded-xl font-medium flex items-center space-x-2">
                                            <i class="fas fa-paper-plane"></i>
                                            <span>Отправить</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="premium-card rounded-2xl overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Информация</h2>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Статус</label>
                                            <select id="taskStatusSelect" onchange="App.updateTaskStatus()" class="premium-input w-full rounded-xl focus-premium">
                                                <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>К выполнению</option>
                                                <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>В работе</option>
                                                <option value="done" ${task.status === 'done' ? 'selected' : ''}>Выполнено</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Приоритет</label>
                                            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${this.getPriorityClass(task.priority)}">
                                                <span class="priority-indicator priority-${task.priority} mr-2"></span>
                                                ${this.getPriorityText(task.priority)}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Создана</label>
                                            <p class="text-gray-700 dark:text-gray-300">${new Date(task.created_at).toLocaleString()}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Срок</label>
                                            <p class="text-gray-700 dark:text-gray-300">${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'Не установлен'}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Исполнитель</label>
                                            <p class="text-gray-700 dark:text-gray-300">${task.assigned_user ? this.escapeHtml(task.assigned_user.full_name) : 'Не назначен'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Загружаем подзадачи и комментарии
                this.loadSubtasks(task.id);
                this.loadTaskComments(task.id);
            }

            static async loadSubtasks(parentTaskId) {
                try {
                    if (!currentProject || !currentProject.hash) {
                        console.error('No current project for loading subtasks');
                        document.getElementById('subtasksList').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Ошибка загрузки подзадач: проект не выбран</p>';
                        return;
                    }

                    // Получаем все задачи проекта
                    const response = await ApiService.getTasks(currentProject.hash);
                    const tasks = response.tasks || [];
                    const subtasks = tasks.filter(task => task.parent_task_id === parentTaskId);
                    const container = document.getElementById('subtasksList');

                    if (subtasks.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                    <i class="fas fa-tasks text-xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Подзадач нет</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Создайте первую подзадачу для этой задачи</p>
                                <button class="btn-premium bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-xl font-medium" onclick="App.showCreateSubtaskModal()">
                                    <i class="fas fa-plus mr-2"></i> Создать подзадачу
                                </button>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = subtasks.map(subtask => `
                        <div class="flex items-center p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-white dark:hover:bg-gray-800 transition-colors">
                            <div class="custom-checkbox ${subtask.status === 'done' ? 'checked' : ''} mr-4" onclick="App.toggleSubtaskStatus(${subtask.id}, this)"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-gray-100">${this.escapeHtml(subtask.title)}</div>
                                <div class="flex items-center mt-1 space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center"><span class="priority-indicator priority-${subtask.priority}"></span> ${this.getPriorityText(subtask.priority)}</span>
                                    <span><i class="fas fa-calendar-alt mr-1"></i> ${subtask.due_date ? new Date(subtask.due_date).toLocaleDateString() : 'Без срока'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading subtasks:', error);
                    document.getElementById('subtasksList').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Ошибка загрузки подзадач</p>';
                }
            }

            static async loadTaskComments(taskId) {
                try {
                    const response = await ApiService.getTaskComments(taskId);
                    const comments = response.comments || [];
                    const container = document.getElementById('taskCommentsList');

                    if (!comments || comments.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Комментариев нет</p>';
                        return;
                    }

                    container.innerHTML = comments.map(comment => `
                        <div class="flex space-x-3 mb-4 last:mb-0">
                            <div class="avatar bg-gradient-to-br from-primary-500 to-primary-600">
                                ${comment.author_name ? comment.author_name.charAt(0).toUpperCase() : 'A'}
                            </div>
                            <div class="flex-1">
                                <div class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="font-medium text-gray-900 dark:text-gray-100">${this.escapeHtml(comment.author_name || 'Аноним')}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">${new Date(comment.created_at).toLocaleString()}</div>
                                    </div>
                                    <p class="text-gray-700 dark:text-gray-300">${this.escapeHtml(comment.content)}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading task comments:', error);
                    document.getElementById('taskCommentsList').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Ошибка загрузки комментариев</p>';
                }
            }

            static showModal(modalId) {
                UIUtils.showModal(modalId);
            }

            static hideModal(modalId) {
                UIUtils.hideModal(modalId);
            }

            static toggleSidebar() {
                UIUtils.toggleSidebar();
            }

            static showCreateProjectModal() {
                this.showModal('createProjectModal');
            }

            static async handleCreateProject() {
                const title = document.getElementById('projectTitle').value.trim();
                const description = document.getElementById('projectDescription').value.trim();
                const isPrivate = document.getElementById('projectIsPrivate').checked;
                const requiresApproval = document.getElementById('projectRequiresApproval').checked;

                if (!title) {
                    this.showError('Введите название проекта');
                    return;
                }

                try {
                    console.log('Creating project:', { title, description, isPrivate, requiresApproval });
                    await ApiService.createProject({
                        title,
                        description,
                        is_private: isPrivate,
                        requires_approval: requiresApproval
                    });

                    // Закрываем модальное окно
                    this.hideModal('createProjectModal');

                    // Очищаем форму
                    document.getElementById('createProjectForm').reset();

                    // Перезагружаем данные
                    await this.loadData();

                    this.showSuccess('Проект создан успешно!');
                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showError('Ошибка создания проекта: ' + error.message);
                }
            }

            static showCreateTaskModal() {
                this.showModal('createTaskModal');
            }

            static async handleCreateTask() {
                if (!currentProject) return;

                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const priority = document.getElementById('taskPriority').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const assignedTo = document.getElementById('taskAssignedTo').value;

                if (!title) {
                    this.showError('Введите название задачи');
                    return;
                }

                try {
                    const taskData = {
                        title,
                        description,
                        project_hash: currentProject.hash,
                        priority,
                        status: 'todo'
                    };

                    if (dueDate) taskData.due_date = dueDate;
                    // ИСПРАВЛЕНО: используем assigned_to_id вместо assigned_to_ids
                    if (assignedTo) {
                        taskData.assigned_to_id = parseInt(assignedTo);
                    }

                    console.log('Creating task with data:', taskData);
                    await ApiService.createTask(taskData);

                    this.hideModal('createTaskModal');

                    // ИСПРАВЛЕНО: Проверяем существование формы перед reset
                    const createTaskForm = document.getElementById('createTaskForm');
                    if (createTaskForm) {
                        createTaskForm.reset();
                    }

                    // Перезагружаем задачи проекта
                    if (currentProject && currentProject.hash) {
                        await this.loadProjectTasks(currentProject.hash);
                    }

                    this.showSuccess('Задача создана успешно!');
                } catch (error) {
                    console.error('Error creating task:', error);
                    this.showError('Ошибка создания задачи: ' + error.message);
                }
            }

            static showCreateSubtaskModal() {
                // Реализация создания подзадачи
                this.showInfo('Функция создания подзадачи будет реализована в ближайшее время!');
            }

            static showEditTaskModal() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for editing:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                // Реализация редактирования задачи
                this.showInfo('Функция редактирования задачи будет реализована в ближайшее время!');
            }

            static showDeleteTaskModal() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for deletion:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                // Реализация удаления задачи
                if (confirm(`Вы уверены, что хотите удалить задачу "${currentTask.title}"?`)) {
                    this.showInfo('Задача будет удалена в ближайшее время!');
                }
            }

            static async updateTaskStatus() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task or task ID:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                try {
                    const newStatus = document.getElementById('taskStatusSelect').value;
                    console.log('Updating task status:', currentTask.id, newStatus);
                    await ApiService.updateTaskStatus(currentTask.id, newStatus);

                    this.showSuccess('Статус задачи обновлен!');
                } catch (error) {
                    console.error('Error updating task status:', error);
                    this.showError('Ошибка обновления статуса: ' + error.message);

                    // Восстанавливаем предыдущее значение
                    if (currentTask) {
                        document.getElementById('taskStatusSelect').value = currentTask.status;
                    }
                }
            }

            static async addComment() {
                if (!currentTask || !currentTask.id) {
                    console.error('No current task for comment:', currentTask);
                    this.showError('Ошибка: задача не выбрана');
                    return;
                }

                const content = document.getElementById('newCommentText').value.trim();
                if (!content) {
                    this.showError('Введите текст комментария');
                    return;
                }

                try {
                    await ApiService.createTaskComment(currentTask.id, content);
                    document.getElementById('newCommentText').value = '';
                    await this.loadTaskComments(currentTask.id);
                    this.showSuccess('Комментарий добавлен!');
                } catch (error) {
                    console.error('Error adding comment:', error);
                    this.showError('Ошибка добавления комментария: ' + error.message);
                }
            }

            static async toggleSubtaskStatus(taskId, checkbox) {
                try {
                    const isChecked = checkbox.classList.contains('checked');
                    const newStatus = isChecked ? 'todo' : 'done';

                    await ApiService.updateTaskStatus(taskId, newStatus);

                    if (isChecked) {
                        checkbox.classList.remove('checked');
                    } else {
                        checkbox.classList.add('checked');
                    }

                    this.showSuccess('Статус подзадачи обновлен!');
                } catch (error) {
                    console.error('Error updating subtask status:', error);
                    this.showError('Ошибка обновления статуса подзадачи: ' + error.message);
                }
            }

            static async showNotifications() {
                try {
                    const response = await ApiService.getNotifications();
                    const notifications = response.notifications || [];

                    // В реальном приложении здесь будет обновление списка уведомлений
                    this.showModal('notificationsModal');
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    this.showError('Ошибка загрузки уведомлений: ' + error.message);
                }
            }

            static async markAllNotificationsRead() {
                try {
                    await ApiService.markAllNotificationsRead();
                    this.hideModal('notificationsModal');
                    this.showSuccess('Все уведомления отмечены как прочитанные!');
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                    this.showError('Ошибка отметки уведомлений: ' + error.message);
                }
            }

            static showSettings() {
                // Реализация настроек
                this.showInfo('Настройки будут доступны в ближайшее время!');
            }

            static showMyTasks() {
                // Реализация показа задач пользователя
                this.showInfo('Раздел "Мои задачи" будет доступен в ближайшее время!');
            }

            static backToProject() {
                console.log('Back to project, currentProject:', currentProject);
                if (currentProject && currentProject.hash) {
                    this.openProject(currentProject.hash);
                } else {
                    console.log('No current project, showing dashboard');
                    this.showDashboard();
                }
            }

            // Вспомогательные методы
            static getStatusText(status) {
                const statusMap = {
                    'todo': 'К выполнению',
                    'in_progress': 'В работе',
                    'done': 'Выполнено'
                };
                return statusMap[status] || status;
            }

            static getPriorityText(priority) {
                const priorityMap = {
                    'low': 'Низкий',
                    'medium': 'Средний',
                    'high': 'Высокий',
                    'urgent': 'Срочный'
                };
                return priorityMap[priority] || priority;
            }

            static getPriorityClass(priority) {
                const classMap = {
                    'low': 'bg-success-100 text-success-800 dark:bg-success-900 dark:text-success-200',
                    'medium': 'bg-warning-100 text-warning-800 dark:bg-warning-900 dark:text-warning-200',
                    'high': 'bg-danger-100 text-danger-800 dark:bg-danger-900 dark:text-danger-200',
                    'urgent': 'bg-danger-200 text-danger-900 dark:bg-danger-800 dark:text-danger-100'
                };
                return classMap[priority] || classMap.medium;
            }

            static getRoleText(role) {
                const roleMap = {
                    'owner': 'Владелец',
                    'admin': 'Администратор',
                    'member': 'Участник',
                    'guest': 'Гость'
                };
                return roleMap[role] || role;
            }

            static showError(message) {
                UIUtils.showToast(message, 'error');
            }

            static showSuccess(message) {
                UIUtils.showToast(message, 'success');
            }

            static showInfo(message) {
                UIUtils.showToast(message, 'info');
            }

            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
